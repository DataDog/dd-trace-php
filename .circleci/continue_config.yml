version: 2.1
orbs:
  codecov: codecov/codecov@3.2.2

parameters:
  build:
    type: boolean
    default: true
  components-c:
    type: boolean
    default: false
  profiling:
    type: boolean
    default: false
  zend_abstract_interface:
    type: boolean
    default: false
  appsec:
    type: boolean
    default: false

aliases:

  - &CACHE_COMPOSER_KEY
    key: 'betav2-composer-deps-{{ .Environment.CIRCLE_JOB }}-{{ checksum "composer.json" }}'

  - &IMAGE_DOCKER_REDIS
    image: datadog/dd-trace-ci:php-redis-5.0
    name: redis_integration

  - &IMAGE_DOCKER_ELASTICSEARCH2
    image: elasticsearch:2
    name: elasticsearch2_integration

  - &IMAGE_DOCKER_ELASTICSEARCH7
    image: elasticsearch:7.17.0
    name: elasticsearch7_integration
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1g -Xmx1g

  - &IMAGE_DOCKER_HTTPBIN
    image: kong/httpbin:0.2.2
    name: httpbin_integration

  - &IMAGE_DOCKER_KAFKA
    image: confluentinc/cp-kafka:7.7.1
    name: kafka_integration
    environment:
      - KAFKA_BROKER_ID=111
      - KAFKA_CREATE_TOPICS=test-lowlevel:1:1,test-highlevel:1:1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka_integration:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true

  - &IMAGE_DOCKER_MEMCHACED
    image: memcached:1.5-alpine
    name: memcached_integration

  - &IMAGE_DOCKER_MYSQL
    image: datadog/dd-trace-ci:php-mysql-dev-5.6
    name: mysql_integration
    environment:
      - MYSQL_ROOT_PASSWORD=test
      - MYSQL_PASSWORD=test
      - MYSQL_USER=test
      - MYSQL_DATABASE=test

  - &IMAGE_DOCKER_MONGO
    image: "circleci/mongo:4.0"
    name: mongodb_integration
    environment:
      - MONGO_INITDB_ROOT_USERNAME=test
      - MONGO_INITDB_ROOT_PASSWORD=test

  - &IMAGE_DOCKER_RABBITMQ
    image: rabbitmq:3.8.9-alpine
    name: rabbitmq_integration

  - &IMAGE_DOCKER_REQUEST_REPLAYER
    image: datadog/dd-trace-ci:php-request-replayer-2.0
    name: request-replayer
    environment:
      DD_REQUEST_DUMPER_FILE: dump.json

  - &IMAGE_DOCKER_DD_TEST_AGENT
    image: ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:latest
    name: test-agent
    environment:
      LOG_LEVEL: DEBUG
      TRACE_LANGUAGE: php
      DD_TRACE_AGENT_URL: http://request-replayer:80
      PORT: 9126
      SNAPSHOT_DIR: /snapshots
      SNAPSHOT_CI: 1
      DD_SUPPRESS_TRACE_PARSE_ERRORS: true
      ENABLED_CHECKS: trace_stall,trace_peer_service,trace_dd_service
      DD_POOL_TRACE_CHECK_FAILURES: true
      DD_DISABLE_ERROR_RESPONSES: true

  - &IMAGE_DOCKER_SQLSRV
    image: mcr.microsoft.com/mssql/server:2022-latest
    name: sqlsrv_integration
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Password12!
      - MSSQL_PID=Developer

  - &IMAGE_DOCKER_GOOGLESPANNER
    image: gcr.io/cloud-spanner-emulator/emulator:1.5.25
    name: googlespanner_integration

  - &IMAGE_DOCKER_ZOOKEEPER
    image: confluentinc/cp-zookeeper:7.7.1
    name: zookeeper
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000


  - &STEP_ATTACH_WORKSPACE
    attach_workspace:
      at: ~/datadog

  - &STEP_EXT_INSTALL
    run:
      name: Build and install extension
      command: make sudo install install_ini BUILD_DIR=$(pwd)/tmp/build_extension $(if [ -f libddtrace_php.a ]; then echo EXTRA_CONFIGURE_OPTIONS=--with-ddtrace-rust-library=$(pwd)/libddtrace_php.a; fi)

  - &STEP_CODE_COVERAGE
    when:
      # codecov uploader only on amd64
      condition:
        and:
          - equal: [ true, << parameters.coverage >> ]
          - matches:
              pattern: "^[^.]+$"
              value: << parameters.resource_class >>
      steps:
        - run:
            name: Merge coverage reports
            command: |
              make merge_coverage_reports
        - run:
            name: Install CodeCov Uploader Dependencies
            command: |
              sudo apt update
              sudo apt install -y gpg
        - codecov/upload:
            file: reports/coverage.xml
            upload_name: "PHP<< parameters.php_major_minor >>.<< parameters.make_target >>.dd-trace-php"
            flags: << parameters.codecov_flags >>

  - &STEP_COMPOSER_CACHE_RESTORE
    restore_cache:
      <<: *CACHE_COMPOSER_KEY

  - &STEP_COMPOSER_CACHE_SAVE
    save_cache:
      <<: *CACHE_COMPOSER_KEY
      paths:
        - ~/.composer/cache

  - &STEP_COMPOSER_SELF_UPDATE
    run:
      name: Upgrading composer
      command: sudo composer self-update --no-interaction

  - &STEP_COMPOSER_UPDATE
    run:
      name: Installing dependencies with composer
      command: |
        export COMPOSER_MEMORY_LIMIT=-1 # disable composer memory limit completely
        composer update --no-interaction

  - &STEP_COMPOSER_GENERATE
    run:
      name: Compiling dd-tace-php files into single file
      command: make generate

  - &STEP_COMPOSER_TESTS_UPDATE
    run:
      name: Updating tests' composer
      command: make composer_tests_update

  - &STEP_PREPARE_TEST_RESULTS_DIR
    run:
      name: testresults dir
      command: mkdir test-results

  - &STEP_EXPORT_CI_ENV
    run:
      name: export .env.circleci
      command: |
        echo "export $(cat .env.circleci | xargs)" >> $HOME/.profile

  - &STEP_DISABLE_XDEBUG
    run:
      name: Disable Xdebug for built-in web tests
      command: test -e /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && sudo rm -f $_ || true

  - &STEP_WAIT_MYSQL
    run:
      name: Waiting for Dockerized MySQL
      command: wait-for mysql_integration:3306 --timeout=60

  - &STEP_WAIT_REQUEST_REPLAYER
    run:
      name: Waiting for Dockerized request replayer
      command: wait-for request-replayer:80 --timeout=120

  - &STEP_WAIT_TEST_AGENT
    run:
      name: Waiting for Dockerized APM Test Agent
      command: wait-for test-agent:9126 --timeout=30

  - &STEP_GET_TEST_AGENT_RESULTS
    run:
      name: Get APM Test Agent Trace Check Results
      when: always
      command: |
        sudo apt update
        sudo apt install -y jq
        set +e  # Disable exiting from testagent response failure
        SUMMARY_RESPONSE=$(curl -s -w "\n%{http_code}" -o summary_response.txt http://test-agent:9126/test/trace_check/summary)
        set -e
        SUMMARY_RESPONSE_CODE=$(echo "$SUMMARY_RESPONSE" | awk 'END {print $NF}')
        if [[ SUMMARY_RESPONSE_CODE -eq 200 ]]; then
          echo "APM Test Agent is running. (HTTP 200)"
        else
          echo "APM Test Agent is not running and was not used for testing. No checks failed."
          exit 0
        fi

        RESPONSE=$(curl -s -w "\n%{http_code}" -o response.txt http://test-agent:9126/test/trace_check/failures)
        RESPONSE_CODE=$(echo "$RESPONSE" | awk 'END {print $NF}')

        if [[ $RESPONSE_CODE -eq 200 ]]; then
          echo "All APM Test Agent Check Traces returned successful! (HTTP 200)"
          echo "APM Test Agent Check Traces Summary Results:"
          cat summary_response.txt | jq '.'
        elif [[ $RESPONSE_CODE -eq 404 ]]; then
          echo "Real APM Agent running in place of TestAgent, no checks to validate!"
        else
          echo "APM Test Agent Check Traces failed with response code: $RESPONSE_CODE"
          echo "Failures:"
          cat response.txt
          echo "APM Test Agent Check Traces Summary Results:"
          cat summary_response.txt | jq '.'
          exit 1
        fi

  # Fix intermittent error: "Could not resolve host: httpbin_integration"
  - &STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
    run:
      name: Resolving HTTPBIN_HOSTNAME to IP address
      command: |
        export HTTPBIN_HOSTNAME=$( \
          curl --verbose "http://httpbin_integration:80/headers" 2>&1 | \
          grep '* Connected to' | \
          awk -F' ' '{print $5}' | \
          sed 's/[()]//g' \
        );
        echo "Resolved httpbin_integration: HTTPBIN_HOSTNAME=${HTTPBIN_HOSTNAME}";
        echo "export HTTPBIN_HOSTNAME='${HTTPBIN_HOSTNAME}'" >> $BASH_ENV
        # Avoid intermittent DNS hangs: See https://github.com/curl/curl/issues/593#issuecomment-170146252
        echo "options single-request" | sudo tee -a /etc/resolv.conf

  - &STEP_LINK_EXTENSION
    run:
      name: Link extension
      background: true
      command: |
        echo $$ > /tmp/link_extension.pid
        # If it's missing, we're building in the job
        if [ -f ddtrace.a ]; then
          sed -i 's/-export-symbols .*\/ddtrace\.sym/-Wl,--retain-symbols-file=ddtrace.sym/g' ddtrace.ldflags
          cc -shared -Wl,-whole-archive ddtrace.a -Wl,-no-whole-archive $(cat ddtrace.ldflags) libddtrace_php.a -Wl,-soname -Wl,ddtrace.so -o ddtrace.so
          mkdir -p tmp/build_extension/modules
          mv ddtrace.so tmp/build_extension/modules/
        fi

  - &STEP_AWAIT_LINK_EXTENSION
    run:
      name: Wait for extension linking
      command: |
        tail --pid=$(cat /tmp/link_extension.pid) -f /dev/null || true
        if [ -f tmp/build_extension/modules/ddtrace.so ]; then
          echo "export DD_TRACE_ASSUME_COMPILED=1" >> $BASH_ENV
        fi

  - &STEP_SUBSTITUTE_SNAPSHOT_DIR
    run:
      name: Replace /home/circleci/app by /home/circleci/datadog in snapshot results
      command: |
        for f in $(find tests/snapshots -type f); do
          sed -i 's/\/home\/circleci\/app\//\/home\/circleci\/datadog\//g' $f
        done

  - &STEP_STORE_TEST_RESULTS
    store_test_results:
      path: test-results

  - &BARE_DOCKER_MACHINE
    resource_class: << parameters.resource_class >>
    machine:
      image: ubuntu-2004:current

commands:
  git_checkout:
    parameters:
      is_windows:
        type: boolean
        default: false
    steps:
      - run:
          name: Checkout code
          shell: "<<# parameters.is_windows >>bash.exe<</ parameters.is_windows >>"
          command: |
            git config --global gc.auto 0

            export CIRCLE_REPOSITORY_URL="${CIRCLE_REPOSITORY_URL/git@github.com:/https://github.com/}"

            APP_DIR="$HOME/datadog"
            if [ -e "$APP_DIR/.git" ] ; then
              echo 'Fetching into existing repository'
              existing_repo='true'
              cd "$APP_DIR"
              git remote set-url origin "$CIRCLE_REPOSITORY_URL" || true

              echo 'Fetching from remote repository'
              retry_count=3
              if [ -n "$CIRCLE_TAG" ]; then
                for i in $(seq 1 $retry_count); do
                  git fetch --force --no-recurse-submodules --tags origin && break || sleep 1
                done
              elif [ -z "$CIRCLE_PR_NUMBER" ]; then
                for i in $(seq 1 $retry_count); do
                  git fetch --force --no-recurse-submodules origin "+refs/heads/$CIRCLE_BRANCH:refs/remotes/origin/$CIRCLE_BRANCH" && break || sleep 1
                done
              fi
            else
              echo 'Cloning git repository'
              existing_repo='false'
              mkdir -p "$APP_DIR"
              cd "$APP_DIR"
              git clone --no-checkout "$CIRCLE_REPOSITORY_URL" .
            fi

            if [ -n "$CIRCLE_TAG" ]; then
              echo 'Checking out tag'
              git checkout --force "$CIRCLE_TAG"
              git reset --hard "$CIRCLE_SHA1"
            else
              echo 'Checking out branch'
              if [ -n "$CIRCLE_PR_NUMBER" ]; then
                git fetch --force origin "+refs/pull/${CIRCLE_PR_NUMBER}/head:refs/remotes/origin/$CIRCLE_BRANCH"
              fi
              git checkout --force -B "$CIRCLE_BRANCH" "$CIRCLE_SHA1"
              git --no-pager log --no-color -n 1 --format='HEAD is now at %h %s'
            fi

            echo 'Updating submodules'
            # we don't need appsec submodules on windows
            <<# parameters.is_windows >>git submodule update --init libdatadog<</ parameters.is_windows >>
            <<^ parameters.is_windows >>git submodule update --init --recursive<</ parameters.is_windows >>

  lib_curl_workaround:
    parameters:
      command:
        type: string
        default: none
    steps:
      - run:
          name: Installing missing libcurl workaround
          command: |
              if [[ ! "<<parameters.command>>" == "none" ]]; then
                << parameters.command >>
              fi;
  switch_php:
    parameters:
      php_version:
        type: string
        default: none
    steps:
      - run:
          name: Switch PHP version
          command: |
            if [[ ! "<<parameters.php_version>>" == "none" ]]; then
              switch-php << parameters.php_version >>
            fi;
  install_extension:
    parameters:
      lib_curl_command:
        type: string
        default: none
    steps:
      - lib_curl_workaround:
          command: << parameters.lib_curl_command >>
      - <<: *STEP_EXT_INSTALL

  append_build_id:
    parameters:
      shell:
        type: string
        default: /bin/bash -eo pipefail
    steps:
      - run:
          name: Append build id to version number and bump it
          shell: << parameters.shell >>
          command: |
            githash="${CIRCLE_SHA1?}"
            if [[ "x$CIRCLE_BRANCH" == "x" ]] ; then
              echo "The environment variable CIRCLE_BRANCH was not set or was empty."
              exit 1
            fi
            if [[ "$CIRCLE_BRANCH" =~ "ddtrace-" ]] ; then
              echo "Release branch detected; not adding git sha1 to version number."
            else
              version=$(cat VERSION)
              # if we have e.g. a beta suffix, just strip it
              if [[ $version == *-* ]]; then
                version=${version%-*}
              else
                # otherwise increment minor version
                parts=($(echo -n "$version" | tr '.' '\n'))
                parts[1]=$((parts[1]+1))
                parts[2]=0
                version=$(export IFS=.; (echo "${parts[*]}"))
              fi
              version="$version+$githash"
              echo -n "$version" > VERSION
              echo "Set version number to $version."
            fi


  fetch_job_artifact:
    parameters:
      job:
        type: string
      artifact:
        type: string
      directory:
        type: string
        default: "."
    steps:
      - run:
          name: "Get artifact << parameters.artifact >> from job << parameters.job >>"
          command: |
            set +x
            cd << parameters.directory >>
            if [[ '<< parameters.job >>' != "${LAST_ARTIFACTS_JOB:-}" ]]; then
              job_id=$(curl -X GET "https://circleci.com/api/v2/workflow/$CIRCLE_WORKFLOW_ID/job" -H "Accept: application/json" | grep -Eo '\{[^}]*"<< parameters.job >>"[^}]*' | grep -Eo '"job_number":[^,]+' | tail -c +14)
              export LAST_ARTIFACTS_RESULT=$(curl -X GET "https://circleci.com/api/v2/project/github/DataDog/dd-trace-php/$job_id/artifacts" -H "Accept: application/json")
              export LAST_ARTIFACTS_JOB='<< parameters.job >>'
            fi
            artifact_url=$(echo "$LAST_ARTIFACTS_RESULT" | grep -Eo '\{[^}]*"<< parameters.artifact >>"[^}]*' | grep -Eo '"url":"[^"]+' | tail -c +8)
            curl -LO "$artifact_url"

  copy_valgrind_rc:
    parameters:
      valgrind_config:
        type: string
        default: ""
    steps:
      - run:
          name: Copy valgrind.rc configuration and suppressions
          command: |
            if [ -e ".circleci/valgrind/<< parameters.valgrind_config >>_valgrind.rc" ]; then
              cp .circleci/valgrind/<< parameters.valgrind_config >>_valgrind.rc /home/circleci/.valgrindrc
              cp .circleci/valgrind/valgrind_<< parameters.valgrind_config >>_suppressions.lib /home/circleci/valgrind_<< parameters.valgrind_config >>_suppressions.lib
            fi
  update_composer_with_cache:
    steps:
      - <<: *STEP_COMPOSER_CACHE_RESTORE
      - <<: *STEP_COMPOSER_UPDATE
      - <<: *STEP_COMPOSER_CACHE_SAVE

  docker_logs:
    parameters:
      docker_image:
        type: string
    steps:
      - run:
          name: Docker logs for << parameters.docker_image >>
          command: docker logs -f << parameters.docker_image >>
          background: true

  setup_docker:
    parameters:
      docker_image:
        type: string
      extra:
        type: string
        default: none
      ramdisk:
        type: boolean
        default: false
    steps:
      - run:
          name: Fix mounted folder permissions mismatch on buster (user 1000 vs user 3434 in docker)
          command: |
            if [[ "<< parameters.docker_image >>" == *buster* ]]; then
              sudo useradd -u 3434 docker-circleci
              sudo chown -R docker-circleci .
            fi
      - run:
          name: Setup container dependencies
          command: |
            set -x
            max_retries=3
            extra=<< parameters.extra >>
            docker network create net --driver=bridge -o "com.docker.network.bridge.name=br"

            function retry_docker() {
              retries=$max_retries
              while
                ! docker "${@}"
              do
                if [[ $((--retries)) -eq 0 ]]; then
                  exit 1
                fi
                sleep 1
              done
              true # Success
            }

            if [[ $extra == "with_httpbin_and_request_replayer" || $extra == "with_snapshots" ]]; then
              retry_docker run --detach --rm --net net \
                -e DD_APM_ENABLED=true \
                -e DD_BIND_HOST=0.0.0.0 \
                -e DD_API_KEY=invalid_key_but_this_is_fine \
                -e LOG_LEVEL=DEBUG \
                -e TRACE_LANGUAGE=php \
                -e DD_TRACE_AGENT_URL=http://request-replayer:80 \
                -e ENABLED_CHECKS=trace_stall,trace_peer_service,trace_dd_service \
                -e DD_SUPPRESS_TRACE_PARSE_ERRORS=true \
                -e DD_POOL_TRACE_CHECK_FAILURES=true \
                -e DD_DISABLE_ERROR_RESPONSES=true \
                -e PORT=9126 \
                -e SNAPSHOT_DIR=/snapshots \
                -p "127.0.0.1:9126:9126" \
                -v $(pwd)/tests/snapshots:/snapshots \
                --name test-agent ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:latest
              retry_docker run --detach --rm --net net \
                --name httpbin_integration kong/httpbin:0.2.2
              retry_docker run --detach --rm --net net \
                -e DD_REQUEST_DUMPER_FILE=dump.json \
                --name request-replayer datadog/dd-trace-ci:php-request-replayer-2.0
            fi
            if [[ $extra == "with_snapshots" ]]; then
              retry_docker run --detach --rm --net net \
                --name elasticsearch2_integration elasticsearch:2
              retry_docker run --detach --rm --net net \
                -e ES_JAVA_OPTS="-Xms1g -Xmx1g" \
                -e discovery.type=single-node \
                --name elasticsearch7_integration elasticsearch:7.17.0
              retry_docker run --detach --rm --net net \
                -e ZOOKEEPER_CLIENT_PORT=2181 \
                -e ZOOKEEPER_TICK_TIME=2000 \
                --name zookeeper confluentinc/cp-zookeeper:7.7.1
              retry_docker run --detach --rm --net net \
                -e KAFKA_BROKER_ID=111 \
                -e KAFKA_CREATE_TOPICS=test-lowlevel:1:1,test-highlevel:1:1 \
                -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
                -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka_integration:9092 \
                -e KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT \
                -e KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT \
                -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
                -e KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1 \
                -e KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1 \
                -e KAFKA_AUTO_CREATE_TOPICS_ENABLE=true \
                --name kafka_integration confluentinc/cp-kafka:7.7.1
              retry_docker run --detach --rm --net net \
                --name redis_integration datadog/dd-trace-ci:php-redis-5.0
              retry_docker run --detach --rm --net net \
                --name memcached_integration memcached:1.5-alpine
              retry_docker run --detach --rm --net net \
                -e MYSQL_ROOT_PASSWORD=test \
                -e MYSQL_PASSWORD=test \
                -e MYSQL_USER=test \
                -e MYSQL_DATABASE=test \
                --name mysql_integration datadog/dd-trace-ci:php-mysql-dev-5.6
              retry_docker run --detach --rm --net net \
                --name rabbitmq_integration rabbitmq:3.8.9-alpine
              retry_docker run --detach --rm --net net \
                -e MONGO_INITDB_ROOT_USERNAME=test \
                -e MONGO_INITDB_ROOT_PASSWORD=test \
                --name mongodb_integration circleci/mongo:4.0
              retry_docker run --detach --rm --net net \
                -e ACCEPT_EULA=Y \
                -e MSSQL_SA_PASSWORD=Password12! \
                -e MSSQL_PID=Developer \
                --name sqlsrv_integration mcr.microsoft.com/mssql/server:2022-latest
              retry_docker run --detach --rm --net net \
                --name googlespanner_integration gcr.io/cloud-spanner-emulator/emulator:1.5.25
            fi
      - when:
          condition:
            or:
              - equal: [ "with_httpbin_and_request_replayer", << parameters.extra >> ]
              - equal: [ "with_snapshots", << parameters.extra >> ]
          steps:
            - docker_logs:
                docker_image: test-agent
            - docker_logs:
                docker_image: httpbin_integration
            - docker_logs:
                docker_image: request-replayer
      - when:
          condition:
            equal: [ "with_snapshots", << parameters.extra >> ]
          steps:
            - docker_logs:
                docker_image: elasticsearch2_integration
            - docker_logs:
                docker_image: elasticsearch7_integration
            - docker_logs:
                docker_image: kafka_integration
            - docker_logs:
                docker_image: redis_integration
            - docker_logs:
                docker_image: memcached_integration
            - docker_logs:
                docker_image: mysql_integration
            - docker_logs:
                docker_image: rabbitmq_integration
            - docker_logs:
                docker_image: mongodb_integration
            - docker_logs:
                docker_image: sqlsrv_integration
            - docker_logs:
                docker_image: googlespanner_integration
            - docker_logs:
                docker_image: zookeeper
      - run:
          name: Setup docker image << parameters.docker_image >>
          command: |
            touch /tmp/docker.out
            mkdir /tmp/bashenv
            sudo mkdir /rust
            sudo chmod 777 /rust
            mkdir /tmp/artifacts
            sudo chmod 777 /tmp/artifacts
            image=<< parameters.docker_image >>
            retries=$max_retries
            while
              nohup docker run --rm --net net \
                  --cap-add=SYS_PTRACE --security-opt seccomp=unconfined \
                  -e DDAGENT_HOSTNAME=127.0.0.1 \
                  -e DD_AGENT_HOST=127.0.0.1 \
                  -e DATADOG_HAVE_DEV_ENV=1 \
                  -e BASH_ENV=/home/circleci/bashenv/bash.sh \
                  -e ASAN_OPTIONS="abort_on_error=1:disable_coredump=0:unmap_shadow_on_exit=1" \
                  -e CIRCLE_SHA1 \
                  -e CIRCLE_BRANCH \
                  -e CODECOV_TOKEN \
                  -e CI \
                  -e CIRCLECI \
                  -e CIRCLE_PROJECT_USERNAME \
                  -e CIRCLE_PROJECT_REPONAME \
                  <<# parameters.ramdisk >>--tmpfs /mnt/ramdisk:uid=3434,gid=3434,exec<</ parameters.ramdisk >> \
                  -v $(pwd):/home/circleci/datadog \
                  -v /tmp/bashenv:/home/circleci/bashenv \
                  -v /rust:/rust \
                  -v /tmp/artifacts:/tmp/artifacts \
                  $(if [ -n "${CARGO_TARGET_DIR:-}" ]; then echo "-e CARGO_TARGET_DIR=${CARGO_TARGET_DIR}"; fi) \
                  $image \
                  sh -c 'echo Started; sleep 10000' 2>&1 | tee /tmp/docker.out &
              tail -F /tmp/docker.out | grep -Em1 'Started|Error response from daemon'
              if ! grep -q "Error response from daemon" /tmp/docker.out; then
                container_name=$(docker ps | grep "$image" | awk '{ print $NF }' | head -1)
                [[ -z $container_name ]]
              fi
            do
              if [[ $((--retries)) -eq 0 ]]; then
                cat /tmp/docker.out
                echo ---
                echo "Could not start container $image"
                exit 1
              fi
              sleep 1
            done
            # On Alpine images, make sure bash is installed
            if [[ "<< parameters.docker_image >>" == *alpine* ]]; then
              docker exec -w /home/circleci/datadog -i "${container_name}" sh -c "test -z bash || apk --no-cache add bash" || true
            fi
            echo 'if [ -f /usr/bin/docker ]; then pid=$$; IFS= readarray -d "" args < <(cat /proc/$pid/cmdline); exec docker exec -w /home/circleci/datadog -i '"${container_name}"' "${args[@]}"; fi' | tee -a $BASH_ENV
            cp $BASH_ENV /tmp/bashenv/bash.sh
            chmod 777 /tmp/bashenv/bash.sh

  build_profiler:
    parameters:
      prefix:
        type: string
    steps:
      - run:
          name: Build Profiler NTS
          shell: /bin/bash -ieo pipefail
          command: |
            source "$BASH_ENV"
            if [ -d '/opt/rh/devtoolset-7' ] ; then
                set +eo pipefail
                source scl_source enable devtoolset-7
                set -eo pipefail
            fi
            set -u
            prefix="<< parameters.prefix >>"
            mkdir -vp "${prefix}"
            switch-php "${PHP_VERSION}"
            cd profiling
            echo "${CARGO_TARGET_DIR}"
            cargo build --release
            cd -
            cp -v "${CARGO_TARGET_DIR}/release/libdatadog_php_profiling.so" "${prefix}/datadog-profiling.so"
            objcopy --compress-debug-sections "${prefix}/datadog-profiling.so"
      - run:
          name: Build Profiler ZTS
          shell: /bin/bash -ieo pipefail
          command: |
            source "$BASH_ENV"
            if [ -d '/opt/rh/devtoolset-7' ] ; then
                set +eo pipefail
                source scl_source enable devtoolset-7
                set -eo pipefail
            fi
            set -u
            prefix="<< parameters.prefix >>"
            mkdir -vp "${prefix}"
            switch-php "${PHP_VERSION}-zts"
            cd profiling
            echo "${CARGO_TARGET_DIR}"
            touch build.rs #make sure `build.rs` gets executed after `switch-php` call
            cargo build --release
            cd -
            cp -v "${CARGO_TARGET_DIR}/release/libdatadog_php_profiling.so" "${prefix}/datadog-profiling-zts.so"
            objcopy --compress-debug-sections "${prefix}/datadog-profiling-zts.so"

executors:
  with_agent:
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
    parameters:
      docker_image:
        type: string
    docker:
      - image: << parameters.docker_image >>
      - <<: *IMAGE_DOCKER_DD_TEST_AGENT
  with_httpbin_and_request_replayer:
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
    parameters:
      docker_image:
        type: string
    docker:
      - image: << parameters.docker_image >>
      - <<: *IMAGE_DOCKER_HTTPBIN
      - <<: *IMAGE_DOCKER_REQUEST_REPLAYER
      - <<: *IMAGE_DOCKER_DD_TEST_AGENT
  with_integrations:
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
      COMPOSER_MEMORY_LIMIT: -1 # disable composer memory limit completely
    parameters:
      docker_image:
        type: string
    docker:
      - image: << parameters.docker_image >>
      - <<: *IMAGE_DOCKER_ELASTICSEARCH2
      - <<: *IMAGE_DOCKER_ELASTICSEARCH7
      - <<: *IMAGE_DOCKER_HTTPBIN
      - <<: *IMAGE_DOCKER_REDIS
      - <<: *IMAGE_DOCKER_KAFKA
      - <<: *IMAGE_DOCKER_MEMCHACED
      - <<: *IMAGE_DOCKER_MYSQL
      - <<: *IMAGE_DOCKER_RABBITMQ
      - <<: *IMAGE_DOCKER_MONGO
      - <<: *IMAGE_DOCKER_REQUEST_REPLAYER
      - <<: *IMAGE_DOCKER_DD_TEST_AGENT
      - <<: *IMAGE_DOCKER_SQLSRV
      - <<: *IMAGE_DOCKER_GOOGLESPANNER
      - <<: *IMAGE_DOCKER_ZOOKEEPER
  with_redis:
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
      COMPOSER_MEMORY_LIMIT: -1 # disable composer memory limit completely
    parameters:
      docker_image:
        type: string
    docker:
        - image: << parameters.docker_image >>
        - <<: *IMAGE_DOCKER_HTTPBIN
        - <<: *IMAGE_DOCKER_REDIS
        - <<: *IMAGE_DOCKER_REQUEST_REPLAYER
        - <<: *IMAGE_DOCKER_DD_TEST_AGENT


jobs:
  static_analysis:
    parameters:
      docker_image:
        type: string
        default: ""
      scenario:
        type: string
        default: ""
      composer_root:
        type: string
        default: "~/.composer"
    working_directory: ~/datadog
    docker:
      - image: << parameters.docker_image >>
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - <<: *STEP_LINK_EXTENSION
      - lib_curl_workaround:
          command: sudo apt update; sudo apt -y install libcurl4-nss-dev
      - update_composer_with_cache
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - <<: *STEP_EXT_INSTALL
      - run:
          name: Install phpstan
          command: |
            composer global require phpstan/phpstan:0.12.*
            composer global require psr/log
            composer scenario:update
      - run:
          name: Running phpstan
          command: composer scenario << parameters.scenario >> ; PATH=$PATH:$(composer --global config home)/vendor/bin composer static-analyze

  "Post-Install Hook":
    working_directory: ~/datadog
    docker:
      - image: datadog/dd-trace-ci:php-nginx-apache2
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Install git
          command: |
            apt-get update
            apt-get install -y git
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Start Supervisor
          command: supervisord
          background: true
      - run:
          name: Copy post-install script
          command: |
            mkdir -p /src/ddtrace-scripts
            cp package/post-install.sh /src/ddtrace-scripts
      - run:
          name: Test post-install hook
          command: bash tests/PostInstallHook/run-tests.sh

  xdebug_tests:
    parameters:
      docker_image:
        type: string
      xdebug_version_one:
        type: string
      xdebug_version_two:
        type: string
        default: none
    working_directory: ~/datadog
    executor:
      name: with_httpbin_and_request_replayer
      docker_image: << parameters.docker_image >>
    resource_class: medium
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - <<: *STEP_LINK_EXTENSION
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - <<: *STEP_EXT_INSTALL
      - run:
          name: Run xdebug tests
          command: |
            export REPORT_EXIT_STATUS=1
            targetdir() {
              if [[ ${1:0:1} -eq 2 ]]; then
                echo $1
              else
                echo "3.0.0"
              fi
            }
            if [[ "<<parameters.xdebug_version_one>>" == "3.4.0" ]]; then
              ln -s $(php-config --extension-dir)/xdebug-3.4.0.so $(php-config --extension-dir)/xdebug-3.4.0alpha2-dev.so
            fi
            php /usr/local/src/php/run-tests.php -g FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP -p $(which php) --show-all -d zend_extension=xdebug-<< parameters.xdebug_version_one >>.so tests/xdebug/$(targetdir << parameters.xdebug_version_one >>)
            if [[ ! "<<parameters.xdebug_version_two>>" == "none" ]]; then
              php /usr/local/src/php/run-tests.php -g FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP -p $(which php) --show-all -d zend_extension=xdebug-<< parameters.xdebug_version_two >>.so tests/xdebug/$(targetdir << parameters.xdebug_version_two >>)
            fi;
      - run:
          name: Run unit tests with xdebug
          command: |
            if [[ "<<parameters.xdebug_version_one>>" != "2.7.2" ]]; then
              TEST_EXTRA_INI='-d zend_extension=xdebug-<< parameters.xdebug_version_one >>.so' make test_unit RUST_DEBUG_BUILD=1 PHPUNIT_OPTS="--log-junit test-results/php-unit/results_unit.xml"
            fi
      - <<: *STEP_STORE_TEST_RESULTS

  test:
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      make_target:
        type: string
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
      coverage:
        type: boolean
        default: false
      codecov_flags:
        type: string
        default: ""
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Set core pattern
          command: |
            sudo sh -c "echo '/tmp/core.%e.%p.%t' > /proc/sys/kernel/core_pattern"
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
          extra: with_httpbin_and_request_replayer
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - update_composer_with_cache
      - <<: *STEP_COMPOSER_TESTS_UPDATE
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      - <<: *STEP_WAIT_TEST_AGENT
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - <<: *STEP_EXT_INSTALL
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            <<# parameters.coverage >>unset CI && unset CIRCLECI && export DD_AUTOLOAD_NO_COMPILE=true<</ parameters.coverage >>
            make << parameters.make_target >> RUST_DEBUG_BUILD=1 PHPUNIT_OPTS="--log-junit test-results/php-unit/results.xml" 2>&1 | tee /dev/stderr | { ! grep -qe "=== Total [0-9]+ memory leaks detected ==="; }
            rm -rf tmp/build_extension/tests/opcache/file_cache/* || true
      - <<: *STEP_CODE_COVERAGE
      - <<: *STEP_STORE_TEST_RESULTS
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find /tmp -name "core*" -type f | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/$(if [[ << parameters.make_target >> == *opcache* ]]; then echo opcache; else echo ext; fi) /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  test_sidecar_sender:
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Set core pattern
          command: |
            sudo sh -c "echo '/tmp/core.%e.%p.%t' > /proc/sys/kernel/core_pattern"
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
          extra: with_httpbin_and_request_replayer
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - update_composer_with_cache
      - <<: *STEP_COMPOSER_TESTS_UPDATE
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - <<: *STEP_EXT_INSTALL
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            DD_TRACE_SIDECAR_TRACE_SENDER=1 _DD_DEBUG_SIDECAR_LOG_METHOD="file://$(pwd)/tmp/build_extension/tests/ext/sidecar.log" make test_c RUST_DEBUG_BUILD=1 PHPUNIT_OPTS="--log-junit test-results/php-unit/results.xml" TESTS=tests/ext/background-sender 2>&1 | tee /dev/stderr | { ! grep -qe "=== Total [0-9]+ memory leaks detected ==="; }
      - <<: *STEP_STORE_TEST_RESULTS
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find /tmp -name "core*" -type f | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/ext /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts

  test_multi_observer:
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Set core pattern
          command: |
            sudo sh -c "echo '/tmp/core.%e.%p.%t' > /proc/sys/kernel/core_pattern"
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
          extra: with_httpbin_and_request_replayer
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - update_composer_with_cache
      - <<: *STEP_COMPOSER_TESTS_UPDATE
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      - <<: *STEP_WAIT_TEST_AGENT
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - <<: *STEP_EXT_INSTALL
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            _DD_DEBUG_SIDECAR_LOG_LEVEL=trace _DD_DEBUG_SIDECAR_LOG_METHOD="file://$(pwd)/tmp/build_extension/tests/ext/sidecar.log" make test_c_observer RUST_DEBUG_BUILD=1 PHPUNIT_OPTS="--log-junit test-results/php-unit/results.xml" 2>&1 | tee /dev/stderr | { ! grep -qe "=== Total [0-9]+ memory leaks detected ==="; }
      - <<: *STEP_STORE_TEST_RESULTS
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find /tmp -name "core.*" | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/ext /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  test_early_php_81:
    working_directory: ~/datadog
    machine:
      image: ubuntu-2004:2023.04.2
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - fetch_job_artifact:
          job: "package extension"
          artifact: 'dd-library-php-[^"]+x86_64-linux-gnu.tar.gz'
      - fetch_job_artifact:
          job: "package extension"
          artifact: 'datadog-setup.php'
      - run:
          command: |
            docker run --rm -v $(pwd):/root -i ubuntu:jammy bash -s \<<COMMANDS
            set -e
            apt-get update -y
            DEBIAN_FRONTEND=noninteractive apt-get install -y php8.1 php8.1-dom php-pear
            cd /root
            php datadog-setup.php --php-bin all --file $(ls dd-library-php-*-x86_64-linux-gnu.tar.gz)
            rm /etc/php/8.1/cli/conf.d/10-opcache.ini
            sed -i 's/datadog.trace.sources_path/\;datadog.trace.sources_path/' /etc/php/8.1/cli/conf.d/98-ddtrace.ini
            DD_TRACE_GIT_METADATA_ENABLED=0 pecl run-tests --showdiff --ini=" -d datadog.trace.cli_enabled=1" \$(find tests/ext -type d)
            COMMANDS

  test_arm:
    machine:
      image: ubuntu-2004:2023.04.2
    resource_class: arm.medium
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 7.4
        type: string
      make_target:
        type: string
      switch_php_version:
        type: string
        default: debug
    working_directory: ~/datadog
    # environment:
    #   DDAGENT_HOSTNAME: 127.0.0.1
    #   DD_AGENT_HOST: 127.0.0.1
    #   DATADOG_HAVE_DEV_ENV: 1
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Install php
          command: sudo apt update; sudo apt install -y php
      - run:
          name: Make executor script executable
          command: chmod a+x ./tooling/bin/run-in-docker-with-ext.sh
      - run:
          name: Fix mounted folder permissions mismatch (user 1000 vs user 3434 in docker)
          command: |
            sudo useradd -u 3434 docker-circleci
            sudo chown -R docker-circleci . tests
      # - <<: *STEP_WAIT_REQUEST_REPLAYER
      - run:
          name: Set core pattern
          command: |
            sudo sh -c "echo '/tmp/core.%e.%p.%t' > /proc/sys/kernel/core_pattern"
      - run:
          name: Run tests
          command: |
            docker-compose run --rm \
              -e DDAGENT_HOSTNAME=127.0.0.1 \
              -e DD_AGENT_HOST=127.0.0.1 \
              -e DATADOG_HAVE_DEV_ENV=1 \
              -e ASAN_OPTIONS="abort_on_error=1:disable_coredump=0:unmap_shadow_on_exit=1" \
              -e PHP_VARIANT=<< parameters.switch_php_version >> \
              -e PHPUNIT_OPTS="--log-junit test-results/php-unit/results.xml" \
              << parameters.php_major_minor >>-buster-arm64 \
                ./tooling/bin/run-in-docker-with-ext.sh make fix_socket_permissions << parameters.make_target >> RUST_DEBUG_BUILD=1
      # - <<: *STEP_COMPOSER_TESTS_UPDATE
      # - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      # - <<: *STEP_EXPORT_CI_ENV
      # - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      # - run:
      #     name: Run tests
      #     command: |
      #       set -euo pipefail
      #       _DD_DEBUG_SIDECAR_LOG_LEVEL=trace _DD_DEBUG_SIDECAR_LOG_METHOD="file://$(pwd)/tmp/build_extension/tests/ext/sidecar.log" make << parameters.make_target >> PHPUNIT_OPTS="--log-junit test-results/php-unit/results.xml" 2>&1 | tee /dev/stderr | { ! grep -qe "=== Total [0-9]+ memory leaks detected ==="; }
      - <<: *STEP_STORE_TEST_RESULTS
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find /tmp -name "core.*" | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/ext /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts

  test_windows:
    working_directory: ~/datadog
    resource_class: 'windows.medium'
    machine:
      image: 'windows-server-2019-vs2019:2022.08.1'
      shell: 'powershell.exe -ExecutionPolicy Bypass'
    parameters:
      docker_image:
        type: string
    steps:
      - git_checkout: { is_windows: true }
      - run:
          name: Setup docker container
          shell: powershell.exe
          command: |
            mkdir dumps
            docker network create -d "nat" -o com.docker.network.windowsshim.dnsservers="1.1.1.1" net
            docker run --network net -d --name httpbin_integration datadog/dd-trace-ci:httpbin-windows
            docker run --network net -d --name request-replayer datadog/dd-trace-ci:php-request-replayer-2.0-windows
            docker run -v ${pwd}:C:\Users\ContainerAdministrator\app --network net -d --name php << parameters.docker_image >> ping -t localhost
      - run:
          name: Build nts
          shell: powershell.exe
          command: |
            docker exec php powershell.exe "cd app; switch-php nts; C:\php\SDK\phpize.bat; .\configure.bat --enable-debug-pack; nmake"
      - run:
          name: Set test environment variables
          shell: powershell.exe
          command: |
            docker exec php powershell.exe 'setx DD_AUTOLOAD_NO_COMPILE true; setx DATADOG_HAVE_DEV_ENV 1; setx DD_TRACE_GIT_METADATA_ENABLED 0'
      - run:
          name: Run extension tests
          shell: powershell.exe
          command: |
            docker exec php powershell.exe 'cd app; $env:_DD_DEBUG_SIDECAR_LOG_LEVEL=trace; $env:_DD_DEBUG_SIDECAR_LOG_METHOD="""file://${pwd}\sidecar.log"""; C:\php\php.exe -n -d memory_limit=-1 -d output_buffering=0 run-tests.php -g FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP --show-diff -p C:\php\php.exe -d "extension=${pwd}\x64\Release\php_ddtrace.dll" "${pwd}\tests\ext"'
#      - run:
#          name: Install the extension and setup composer
#          shell: powershell.exe
#          command: |
#            docker exec php powershell.exe 'cd app; composer --working-dir=.\tests update; $PSDefaultParameterValues["""Out-File:Encoding"""] = """utf8"""; echo """extension=${pwd}\x64\Release\php_ddtrace.dll""" >> /php/php.ini'
#      - run:
#          name: Run some integration tests
#          shell: powershell.exe
#          command: |
#            docker exec php powershell.exe 'cd app; php -d datadog.trace.sources_path=$pwd\src'
      - run:
          when: always
          command: |
            docker exec php cmd.exe /s /c xcopy /y /c /s /e C:\ProgramData\Microsoft\Windows\WER\ReportQueue .\app\dumps\
            exit 0
      - store_artifacts:
          path: sidecar.log
      - store_artifacts:
          path: x64/Release/php_ddtrace.dll
      - store_artifacts:
          path: x64/Release/php_ddtrace.pdb
      - store_artifacts:
          path: dumps

  coverage: &TEST_BASE
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      make_target:
        type: string
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Set core pattern
          command: |
            sudo sh -c "echo '/tmp/core.%e.%p.%t' > /proc/sys/kernel/core_pattern"
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
          extra: with_httpbin_and_request_replayer
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      - <<: *STEP_WAIT_TEST_AGENT
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            if [[ << parameters.switch_php_version >> == *asan* ]]; then export TEST_PHP_JUNIT=$(pwd)/asan-extension-test.xml; fi
            _DD_DEBUG_SIDECAR_LOG_LEVEL=trace _DD_DEBUG_SIDECAR_LOG_METHOD="file://$(pwd)/tmp/build_extension/tests/ext/sidecar.log" make << parameters.make_target >> RUST_DEBUG_BUILD=1 2>&1 | tee /dev/stderr | { ! grep -qe "=== Total [0-9]+ memory leaks detected ==="; }
      - when:
          # codecov uploader only on amd64
          condition:
            matches:
              pattern: "^[^.]+$"
              value: << parameters.resource_class >>
          steps:
            - run:
                name: Install CodeCov Uploader Dependencies
                command: |
                  sudo apt update
                  sudo apt install -y gpg
            - codecov/upload:
                file: tmp/coverage.info
                upload_name: "PHP<< parameters.php_major_minor >>.extension.dd-trace-php"
                flags: tracer-extension
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find /tmp -name "core.*" | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/ext /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  asan: *TEST_BASE

  hunter_cache_debian:
    parameters:
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Cache"
          keys:
            - hunter-cache-debian-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-7.4_buster
      - run:
          name: Install cmake 3.24.4
          command: |
            if [ ! -d "/opt/cmake/3.24.4" ]
            then
              cd /tmp && curl -OL https://github.com/Kitware/CMake/releases/download/v3.24.4/cmake-3.24.4-Linux-$(uname -m).tar.gz
              mkdir -p /opt/cmake/3.24.4
              cd /opt/cmake/3.24.4 && tar -xf /tmp/cmake-3.24.4-Linux-$(uname -m).tar.gz --strip 1
            fi
            echo 'export PATH="/opt/cmake/3.24.4/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
      - run:
          name: CMake
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_TESTING=ON -DHUNTER_ROOT=~/datadog/hunter-cache
            find ~/datadog/hunter-cache -name "*.a"  -printf "%f\n" | sort -u | sha256sum | awk '{print "Dependencies-ID: "$1}' >> ../hunter-cache.id
      - save_cache:
          name: "Save Cache"
          key: hunter-cache-debian-<< parameters.resource_class >>-{{ checksum "appsec/hunter-cache.id" }}
          paths:
            - ~/datadog/hunter-cache

  test_appsec_extension:
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      switch_php_version:
        type: string
        default: nts
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Hunter Cache"
          keys:
            - hunter-cache-debian-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - run:
          name: Install cmake 3.24.4
          command: |
            if [ ! -d "/opt/cmake/3.24.4" ]
            then
              cd /tmp && curl -OL https://github.com/Kitware/CMake/releases/download/v3.24.4/cmake-3.24.4-Linux-$(uname -m).tar.gz
              mkdir -p /opt/cmake/3.24.4
              cd /opt/cmake/3.24.4 && tar -xf /tmp/cmake-3.24.4-Linux-$(uname -m).tar.gz --strip 1
            fi
            echo 'export PATH="/opt/cmake/3.24.4/bin:$PATH"' >> "$BASH_ENV"
            source "$BASH_ENV"
      - run:
          name: CMake
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_BUILD_HELPER=OFF \
              -DDD_APPSEC_TESTING=ON -DHUNTER_ROOT=~/datadog/hunter-cache
      - run:
          name: Test
          command: make -C appsec/build -j $(nproc) xtest

  test_appsec_integration:
    parameters:
      resource_class:
        type: string
        default: large
      targets:
        type: string
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Integration tests
          command: |
            cd appsec/tests/integration && \
            TERM=dumb ./gradlew loadCaches << parameters.targets >> --info -Pbuildscan --scan

  hunter_cache_ubuntu:
    parameters:
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Cache"
          keys:
            - hunter-cache-ubuntu-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: ubuntu:24.04
      - run:
          name: Install dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt update
            apt install -y wget git g++ gcc cmake make curl libcurl4-gnutls-dev git php-dev php-cgi
      - run: git config --global --add safe.directory /home/circleci/datadog/appsec/third_party/libddwaf
      - run:
          name: CMake
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_TESTING=ON -DHUNTER_ROOT=/home/circleci/datadog/hunter-cache
            find /home/circleci/datadog/hunter-cache -name "*.a"  -printf "%f\n" | sort -u | sha256sum | awk '{print "Dependencies-ID: "$1}' >> ../hunter-cache.id
      - save_cache:
          name: "Save Cache"
          key: hunter-cache-ubuntu-<< parameters.resource_class >>-{{ checksum "appsec/hunter-cache.id" }}
          paths:
            - ~/datadog/hunter-cache

  coverage_appsec:
    parameters:
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Cache"
          keys:
            - hunter-cache-ubuntu-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: ubuntu:24.04
      - run:
          name: Install dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt update
            apt install -y wget sudo git g++ gcc gcovr cmake make curl libcurl4-gnutls-dev clang clang-tidy clang-format git php-dev php8.3-xml php-cgi
      - run:
          name: Install rust
          command: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > /tmp/rustup.sh
            chmod +x /tmp/rustup.sh
            /tmp/rustup.sh -y --default-toolchain 1.78
            sudo ln -s $HOME/.cargo/bin/* /usr/bin/
      - run: git config --global --add safe.directory /home/circleci/datadog/appsec/third_party/libddwaf
      - run:
          name: CMake
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_ENABLE_COVERAGE=ON \
              -DDD_APPSEC_TESTING=ON -DHUNTER_ROOT=/home/circleci/datadog/hunter-cache
      - run:
          name: Test
          command: |
            PATH=$PATH:$HOME/.cargo/bin make -C appsec/build -j $(nproc) xtest ddappsec_helper_test
            ./appsec/build/tests/helper/ddappsec_helper_test
      - run:
          name: Generate XML coverage
          command: |
            cd appsec
            gcovr -f '.*src/extension/.*' -x -o coverage.xml
      - run:
          name: Generate HTML coverage
          command: |
            mkdir -p appsec/coverage ; cd appsec
            gcovr --html-details coverage/coverage.html -f ".*src/.*" -d
            tar -cvzf appsec-extension-coverage.tar.gz coverage/
      - store_artifacts:
          path: appsec/appsec-coverage.tar.gz
      - when:
          # codecov uploader only on amd64
          condition:
            matches:
              pattern: "^[^.]+$"
              value: << parameters.resource_class >>
          steps:
            - run:
                name: Install CodeCov Uploader Dependencies
                command: |
                  sudo apt update
                  sudo apt install -y gpg gnupg
                  sudo mkdir -p /root/.gnupg
                  sudo touch /root/.gnupg/trustedkeys.gpg
            - codecov/upload:
                file: appsec/coverage.xml
                upload_name: "appsec-coverage >>"
                flags: appsec-extension

  lint_appsec:
    parameters:
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Cache"
          keys:
            - hunter-cache-ubuntu-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: ubuntu:24.04
      - run:
          name: Install dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt update
            # clang-tidy 16 crashes so we use 17 instead
            apt install -y wget git g++ gcc cmake make curl libcurl4-gnutls-dev clang clang-tidy-17 clang-format-17 git php-dev php-cgi
      - run: git config --global --add safe.directory /home/circleci/datadog/appsec/third_party/libddwaf
      - run:
          name: CMake
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_ENABLE_COVERAGE=OFF \
              -DDD_APPSEC_TESTING=OFF -DHUNTER_ROOT=/home/circleci/datadog/hunter-cache \
              -DCLANG_TIDY=/usr/bin/run-clang-tidy-17 -DCLANG_FORMAT=/usr/bin/clang-format-17
      - run:
          name: Build
          command: make -C appsec/build -j $(nproc) extension ddappsec-helper
      - run:
          name: Lint and Format
          command: make -C appsec/build format tidy

  test_appsec_helper_asan:
    parameters:
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Cache"
          keys:
            - hunter-cache-ubuntu-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: ubuntu:24.04
      - run:
          name: Install dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt update
            apt install -y wget git g++ gcc gcovr cmake make curl libcurl4-gnutls-dev clang clang-tidy clang-format git
      - run: git config --global --add safe.directory /home/circleci/datadog/appsec/third_party/libddwaf
      - run:
          name: CMake
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_BUILD_EXTENSION=OFF \
              -DDD_APPSEC_ENABLE_COVERAGE=OFF -DDD_APPSEC_TESTING=ON \
              -DCMAKE_CXX_FLAGS="-fsanitize=address -fsanitize=leak -DASAN_BUILD" \
              -DCMAKE_C_FLAGS="-fsanitize=address -fsanitize=leak -DASAN_BUILD" \
              -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address -fsanitize=leak" \
              -DCMAKE_MODULE_LINKER_FLAGS="-fsanitize=address -fsanitize=leak" \
              -DHUNTER_ROOT=/home/circleci/datadog/hunter-cache
      - run:
          name: Test
          command: |
            make -C appsec/build -j $(nproc) ddappsec_helper_test
            ./appsec/build/tests/helper/ddappsec_helper_test

  fuzz_appsec_helper:
    parameters:
      resource_class:
        type: string
        default: medium
    working_directory: ~/datadog
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - restore_cache:
          name: "Restore Cache"
          keys:
            - hunter-cache-ubuntu-<< parameters.resource_class >>-
      - setup_docker:
          docker_image: ubuntu:24.04
      - run:
          name: Install dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt update
            apt install -y wget llvm-17 clang-17 cmake make curl libcurl4-gnutls-dev git
            ln -s /usr/bin/clang-17 /usr/bin/clang
            ln -s /usr/bin/clang++-17 /usr/bin/clang++
      - run: git config --global --add safe.directory /home/circleci/datadog/appsec/third_party/libddwaf
      - run:
          name: CMake
          command: |
            export CC=/usr/bin/clang-17
            export CXX=/usr/bin/clang++-17
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=Debug -DDD_APPSEC_BUILD_EXTENSION=OFF \
              -DHUNTER_ROOT=/home/circleci/datadog/hunter-cache
      - run:
          name: Build
          command: make -C appsec/build -j $(nproc) ddappsec_helper_fuzzer corpus_generator
      - run: mkdir -p appsec/tests/fuzzer/{corpus,results,logs}
      - run:
          name: Generate Corpus
          command: |
            cd appsec
            rm -f tests/fuzzer/corpus/*
            ./build/tests/fuzzer/corpus_generator tests/fuzzer/corpus 500
      - run:
          name: Run fuzzer in nop mode
          command: |
            export LLVM_PROFILE_FILE=off.profraw
            cd appsec
            ./build/tests/fuzzer/ddappsec_helper_fuzzer --log_level=off --fuzz-mode=off -max_total_time=60 -rss_limit_mb=4096 -artifact_prefix=tests/fuzzer/results/ tests/fuzzer/corpus/
      - run:
          name: Generate Corpus
          command: |
            cd appsec
            rm -f tests/fuzzer/corpus/*
            ./build/tests/fuzzer/corpus_generator tests/fuzzer/corpus 500
      - run:
          name: Run fuzzer in raw mode
          command: |
            export LLVM_PROFILE_FILE=raw.profraw
            cd appsec
            ./build/tests/fuzzer/ddappsec_helper_fuzzer --log_level=off --fuzz-mode=raw -max_total_time=60 -rss_limit_mb=4096 -artifact_prefix=tests/fuzzer/results/ tests/fuzzer/corpus/
      - run:
          name: Generate Corpus
          command: |
            cd appsec
            rm -f tests/fuzzer/corpus/*
            ./build/tests/fuzzer/corpus_generator tests/fuzzer/corpus 500
      - run:
          name: Run fuzzer in body mode
          command: |
            export LLVM_PROFILE_FILE=body.profraw
            cd appsec
            ./build/tests/fuzzer/ddappsec_helper_fuzzer --log_level=off --fuzz-mode=body -max_total_time=60 -rss_limit_mb=4096 -artifact_prefix=tests/fuzzer/results/ tests/fuzzer/corpus/
      - run:
          name: Generate coverage
          command: |
            cd appsec
            llvm-profdata-17 merge -sparse *.profraw -o default.profdata
            llvm-cov-17 show build/tests/fuzzer/ddappsec_helper_fuzzer -instr-profile=default.profdata -ignore-filename-regex="(tests|third_party|build)" -format=html > fuzzer-coverage.html
            llvm-cov-17 report -instr-profile default.profdata build/tests/fuzzer/ddappsec_helper_fuzzer -ignore-filename-regex="(tests|third_party|build)" -show-region-summary=false
      - store_artifacts:
          path: appsec/fuzzer-coverage.html

  integration_snapshots:
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      make_target:
        type: string
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
      sapi:
        type: string
        default: cli-server
      disable_runner_distributed_tracing:
        type: boolean
        default: false
      coverage:
        type: boolean
        default: false
      codecov_flags:
        type: string
        default: ""
    <<: *BARE_DOCKER_MACHINE
    environment:
      COMPOSER_PROCESS_TIMEOUT: 0
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
          extra: with_snapshots
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - when:
          condition:
            and:
              - or:
                  - equal: [ "8.0", << parameters.php_major_minor >> ]
                  - equal: [ "8.1", << parameters.php_major_minor >> ]
              - not:
                  equal: [ "test_composer", << parameters.make_target >> ]
          steps:
            - run:
                name: Updating composer to v2
                command: sudo composer self-update --2 --no-interaction
      - <<: *STEP_COMPOSER_CACHE_RESTORE
      - <<: *STEP_COMPOSER_UPDATE
      - <<: *STEP_COMPOSER_TESTS_UPDATE
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - when:
          condition:
            equal: [ false, << parameters.coverage >> ]
          steps:
            - <<: *STEP_DISABLE_XDEBUG
      - <<: *STEP_SUBSTITUTE_SNAPSHOT_DIR
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - install_extension
      - <<: *STEP_WAIT_MYSQL
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_WAIT_TEST_AGENT
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            <<# parameters.coverage >>unset CI && unset CIRCLECI && export DD_AUTOLOAD_NO_COMPILE=true<</ parameters.coverage >>
            DD_TRACE_AGENT_TIMEOUT=1000 <<# parameters.disable_runner_distributed_tracing >> DD_DISTRIBUTED_TRACING=false <</ parameters.disable_runner_distributed_tracing >> DD_TRACE_TEST_SAPI=<< parameters.sapi >> make << parameters.make_target >> PHPUNIT_OPTS="--log-junit test-results/php-composer/results-<< parameters.make_target >>.xml"
      - <<: *STEP_CODE_COVERAGE
      - run:
          command: |
            mkdir -p /tmp/artifacts
            find ~/datadog/tests -type f \( -name 'phpunit_error.log' -o -name 'nginx_*.log' -o -name 'apache_*.log' -o -name 'php_fpm_*.log' -o -name 'dd_php_error.log' -o -name 'core*' \) -exec cp --parents '{}' /tmp/artifacts \;
          when: on_fail
      - run:
          name: Save Tested Versions
          command: |
            make tested_versions
          when: always
      - store_artifacts:
          path: /tmp/artifacts/
      - <<: *STEP_COMPOSER_CACHE_SAVE
      - <<: *STEP_STORE_TEST_RESULTS
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  aggregate_tested_versions:
    working_directory: ~/datadog
    docker:
      - image: datadog/dd-trace-ci:php-8.3_buster
    parameters:
      resource_class:
        type: string
        default: medium
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run:
          name: Install required packages
          command: sudo apt-get update && sudo apt-get install -y jq
      - run:
          name: Download & Aggregate Tested Versions
          command: |
            export CI_COMMIT_SHA=${CIRCLE_SHA1}
            export CI_COMMIT_BRANCH=${CIRCLE_BRANCH}
            ./tooling/tested_versions/download_and_aggregate_tested_versions.sh
      - run:
          name: Generate Markdown Table
          command: php ./tooling/tested_versions/generate_markdown_table.php
      - run:
          name: Create or Update PR Branch
          command: ./tooling/tested_versions/create_or_update_supported_versions_pr.sh


  integration:
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      make_target:
        type: string
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
      sapi:
        type: string
        default: cli-server
      disable_runner_distributed_tracing:
        type: boolean
        default: false
      coverage:
        type: boolean
        default: false
      codecov_flags:
        type: string
        default: ""
      with_executor:
        type: string
        default: 'with_integrations'
    resource_class: << parameters.resource_class >>
    executor:
      name: << parameters.with_executor >>
      docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
    environment:
      COMPOSER_PROCESS_TIMEOUT: 0
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - when:
          condition:
            and:
              - or:
                - equal: [ "8.0", << parameters.php_major_minor >> ]
                - equal: [ "8.1", << parameters.php_major_minor >> ]
              - not:
                  equal: [ "test_composer", << parameters.make_target >> ]
          steps:
            - run:
                name: Updating composer to v2
                command: sudo composer self-update --2 --no-interaction
      - <<: *STEP_COMPOSER_CACHE_RESTORE
      - <<: *STEP_COMPOSER_UPDATE
      - <<: *STEP_COMPOSER_TESTS_UPDATE
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - when:
          condition:
            equal: [ false, << parameters.coverage >> ]
          steps:
            - <<: *STEP_DISABLE_XDEBUG
      - <<: *STEP_SUBSTITUTE_SNAPSHOT_DIR
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - install_extension
      - when:
          condition:
            equal: [ "with_integrations", << parameters.with_executor >> ]
          steps:
            - <<: *STEP_WAIT_MYSQL
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_WAIT_TEST_AGENT
      - run:
          name: Run tests
          command: |
            set -euo pipefail
            <<# parameters.coverage >>unset CI && unset CIRCLECI && export DD_AUTOLOAD_NO_COMPILE=true<</ parameters.coverage >>
            DD_TRACE_AGENT_TIMEOUT=1000 <<# parameters.disable_runner_distributed_tracing >> DD_DISTRIBUTED_TRACING=false <</ parameters.disable_runner_distributed_tracing >> DD_TRACE_TEST_SAPI=<< parameters.sapi >> make << parameters.make_target >> RUST_DEBUG_BUILD=1 PHPUNIT_OPTS="--log-junit test-results/php-composer/results.xml"
      - <<: *STEP_CODE_COVERAGE
      - run:
          command: |
            mkdir -p /tmp/artifacts
            find ~/datadog/tests -type f \( -name 'phpunit_error.log' -o -name 'nginx_*.log' -o -name 'apache_*.log' -o -name 'php_fpm_*.log' -o -name 'dd_php_error.log' -o -name 'core*' \) -exec cp --parents '{}' /tmp/artifacts \;
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts/
      - <<: *STEP_COMPOSER_CACHE_SAVE
      - <<: *STEP_STORE_TEST_RESULTS
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  php_language_tests:
    parameters:
      docker_image:
        type: string
      xfail_list:
        type: string
        default: none
      parallel_workers: # Only available for PHP 7.4+
        type: boolean
        default: false
    working_directory: ~/datadog
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
      DD_AGENT_HOST: 127.0.0.1
      SKIP_ONLINE_TESTS: 1 # too flaky
    executor:
      name: with_agent
      docker_image: << parameters.docker_image >>
    resource_class: medium
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - <<: *STEP_LINK_EXTENSION
      - update_composer_with_cache
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - <<: *STEP_EXT_INSTALL
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_WAIT_TEST_AGENT
      - run:
          name: Run tests
          command: |
            sudo rm -f /opt/php/debug/conf.d/memcached.ini
            if [[ ! "<<parameters.xfail_list>>" == "none" ]]; then
              cp "<<parameters.xfail_list>>" /usr/local/src/php/xfail_tests.list
              (
                cd /usr/local/src/php
                cat xfail_tests.list | xargs -n 1 -I{} find {} -name "*.phpt" -delete || true
              )
            fi
            cd /usr/local/src/php
            export DD_TRACE_STARTUP_LOGS=0
            export DD_TRACE_WARN_CALL_STACK_DEPTH=0
            export DD_TRACE_WARN_LEGACY_DD_TRACE=0
            export DD_TRACE_GIT_METADATA_ENABLED=0
            export REPORT_EXIT_STATUS=1
            export TEST_PHP_JUNIT=/tmp/artifacts/tests/php-tests.xml
            mkdir -p /tmp/artifacts/tests
            # replace all hardcoded object ids in tests by %d as ddtrace creates its own objects
            php \<<'PHP'
            <?php
            foreach (explode("\0", trim(shell_exec("find . -type f -name '*.phpt' -print0"))) as $f) {
                $c = file_get_contents($f);
                $n = preg_replace(["/\)#[0-9]+ \(/", "/[0-9]+ is not a valid/"], [")#%d (", "%d is not a valid"], $c);
                if ($c !== $n) {
                    file_put_contents($f, str_replace("--EXPECT--", "--EXPECTF--", $n));
                }
            }
            PHP
            php run-tests.php -q \
              -p /usr/local/bin/php \
              --show-diff \
              -g FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP \
              -d datadog.trace.sources_path=/home/circleci/datadog/src \
              $(if [[ "<<parameters.parallel_workers>>" == "true" ]]; then echo -j5; fi)
      - run:
          command: |
            cd /usr/local/src/php
            mkdir -p /tmp/artifacts/core_dumps
            find ./ -name "core.*" | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            mkdir -p /tmp/artifacts/diffs
            find -type f -name '*.diff' -exec cp --parents '{}' /tmp/artifacts/diffs \;
          when: on_fail
      - store_test_results:
          path: /tmp/artifacts/tests/
      - store_artifacts:
          path: /tmp/artifacts/
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  integration_tests:
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      docker_image:
        type: string
      make_target:
        type: string
      lib_curl_command:
        type: string
        default: none
      switch_php_version:
        type: string
        default: none
      resource_class:
        type: string
        default: medium
      sapi:
        type: string
        default: cli-server
      disable_runner_distributed_tracing:
        type: boolean
        default: false
    <<: *BARE_DOCKER_MACHINE
    environment:
      COMPOSER_PROCESS_TIMEOUT: 0
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
          extra: with_snapshots
      - when:
          condition:
            or:
              - equal: [ "8.0", << parameters.php_major_minor >> ]
              - equal: [ "8.1", << parameters.php_major_minor >> ]
          steps:
            - run:
                name: Updating composer to v2
                command: sudo composer self-update --2 --no-interaction
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - run:
          name: Install required packages
          command: sudo apt update && sudo apt install -y jq
      - <<: *STEP_COMPOSER_CACHE_RESTORE
      - <<: *STEP_COMPOSER_UPDATE
      - <<: *STEP_COMPOSER_TESTS_UPDATE
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_DISABLE_XDEBUG
      - <<: *STEP_SUBSTITUTE_SNAPSHOT_DIR
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - install_extension:
          lib_curl_command: << parameters.lib_curl_command >>
      - <<: *STEP_WAIT_MYSQL
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_WAIT_TEST_AGENT
      - run:
          name: Run << parameters.make_target >> integration tests
          command: DD_TRACE_AGENT_TIMEOUT=1000 <<# parameters.disable_runner_distributed_tracing >> DD_DISTRIBUTED_TRACING=false <</ parameters.disable_runner_distributed_tracing >> DD_TRACE_TEST_SAPI=<< parameters.sapi >> make << parameters.make_target >> RUST_DEBUG_BUILD=1
      - run:
          command: |
            mkdir -p /tmp/artifacts
            find ~/datadog/tests -type f \( -name 'phpunit_error.log' -o -name 'nginx_*.log' -o -name 'apache_*.log' -o -name 'php_fpm_*.log' -o -name 'dd_php_error.log' -o -name 'core*' \) -exec cp --parents '{}' /tmp/artifacts \;
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts/
      - <<: *STEP_COMPOSER_CACHE_SAVE
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  internal_integrations:
    parameters:
      docker_image:
        type: string
      switch_php_version:
        type: string
        default: none
      ext_name:
        type: string
    working_directory: ~/datadog
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
      DD_AGENT_HOST: 127.0.0.1
      DATADOG_HAVE_DEV_ENV: 1
    executor:
      name: with_httpbin_and_request_replayer
      docker_image: << parameters.docker_image >>
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - <<: *STEP_LINK_EXTENSION
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      - <<: *STEP_WAIT_TEST_AGENT
      - run:
          name: Ensure ext/<< parameters.ext_name >> is missing
          command: |
            if php --ri=<< parameters.ext_name >> &> /dev/null
            then
              echo 'ext/<< parameters.ext_name >> is enabled but should not be installed'
              exit 1
            fi
      - <<: *STEP_AWAIT_LINK_EXTENSION
      - run:
          name: Run << parameters.ext_name >> integration tests with ext/<< parameters.ext_name >> as shared lib + leak detection
          command: |
            export _DD_DEBUG_SIDECAR_LOG_LEVEL=trace
            export _DD_DEBUG_SIDECAR_LOG_METHOD="file://$(pwd)/tmp/build_extension/tests/ext/sidecar.log"
            make test_extension_ci \
              RUST_DEBUG_BUILD=1 \
              BUILD_DIR=$(pwd)/tmp/build_extension \
              JUNIT_RESULTS_DIR=$(pwd)/test-results \
              RUN_TESTS_EXTRA_ARGS="-d extension=mbstring.so -d extension=<< parameters.ext_name >>.so" \
              TESTS="tests/ext/integrations/<< parameters.ext_name >>"
            if [ "<< parameters.ext_name >>" = "curl" ]
            then
              for curlVersion in 7.72.0 7.77.0
              do
                make test_c \
                  RUST_DEBUG_BUILD=1 \
                  BUILD_DIR=$(pwd)/tmp/build_extension \
                  JUNIT_RESULTS_DIR=$(pwd)/test-results \
                  RUN_TESTS_EXTRA_ARGS="-d extension=mbstring.so -d extension=<< parameters.ext_name >>-${curlVersion}.so" \
                  TESTS="tests/ext/integrations/<< parameters.ext_name >>"
              done
            fi
      - <<: *STEP_STORE_TEST_RESULTS
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find tmp -name "core.*" | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/ext /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  min_install_tests:
    parameters:
      php_version:
        type: string
    working_directory: ~/datadog
    environment:
      DDAGENT_HOSTNAME: 127.0.0.1
      DD_AGENT_HOST: 127.0.0.1
      DATADOG_HAVE_DEV_ENV: 1
    executor:
      name: with_httpbin_and_request_replayer
      docker_image: datadog/dd-trace-ci:php-<< parameters.php_version >>-shared-ext
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_PREPARE_TEST_RESULTS_DIR
      - <<: *STEP_EXPORT_CI_ENV
      - fetch_job_artifact:
          job: "package extension"
          artifact: |-
            datadog-php-tracer_[^"]+'"$(if [ $(uname -m) = "aarch64" ]; then echo arm64; else echo amd64; fi)"'.deb
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      - <<: *STEP_WAIT_TEST_AGENT
      - run:
          name: Install .deb from artifacts
          command: |
            sudo dpkg -i *$(if [ $(uname -m) = "aarch64" ]; then echo arm64; else echo amd64; fi)*.deb
            php --ri=ddtrace
      - run:
          name: Run phpt tests against shippable package
          command: |
            switch-php debug
            export DDTRACE_PKG_SO="/opt/datadog-php/extensions/ddtrace-$(php -i | awk '/^PHP[ \t]+API[ \t]+=>/ { print $NF }')-debug.so"
            make run_tests TESTS="-d 'extension=$DDTRACE_PKG_SO' tests/ext" MAX_TEST_PARALLELISM=8
      - run:
          name: Run phpt tests against build from source
          command: |
            make test_c MAX_TEST_PARALLELISM=8
      - <<: *STEP_STORE_TEST_RESULTS
      - run:
          command: |
            mkdir -p /tmp/artifacts/core_dumps
            find tmp -name "core.*" | xargs -I % -n 1 cp % /tmp/artifacts/core_dumps
            cp -a tmp/build_extension/tests/ext /tmp/artifacts/tests
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts
      - <<: *STEP_GET_TEST_AGENT_RESULTS

  framework_tests:
    working_directory: ~/datadog
    parameters:
      framework_target:
        type: string
        default: all
    executor:
      name: with_agent
      docker_image: cimg/php:7.3
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run: mkdir -p build/packages
      - fetch_job_artifact:
          job: "package extension"
          artifact: |-
            datadog-php-tracer_[^"]+'"$(if [ $(uname -m) = "aarch64" ]; then echo arm64; else echo amd64; fi)"'.deb
          directory: build/packages
      - setup_remote_docker
      - run: make -f dockerfiles/frameworks/Makefile << parameters.framework_target >>

  verify_alpine:
    working_directory: ~/datadog
    resource_class: small
    parameters:
      docker_image:
        type: string
      php_package:
        type: string
      install_type:
        type: string
        # Possible values: php_installer, native_package
        default: php_installer
    docker:
      - image: << parameters.docker_image >>
        environment:
          PHP_PACKAGE: << parameters.php_package >>
          OS_NAME: alpine
          DD_AGENT_HOST: request-replayer
          DD_TRACE_AGENT_PORT: 80
          DD_TRACE_AGENT_FLUSH_INTERVAL: 1000
          INSTALL_TYPE: << parameters.install_type >>
          VERIFY_APACHE: 'no'
      - <<: *IMAGE_DOCKER_REQUEST_REPLAYER
    steps:
      - run:
          # see https://support.circleci.com/hc/en-us/articles/360016505753-Resolve-Certificate-Signed-By-Unknown-Authority-error-in-Alpine-images?flash_digest=39b76521a337cecacac0cc10cb28f3747bb5fc6a
          name: Install ca-certificates
          command: apk add --no-cache ca-certificates
      - run:
          name: Install git
          command: apk add git
      - run:
          name: Install curl
          command: apk add curl
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run: mkdir -p build/packages
      - when:
          condition:
            equal: [php_installer, << parameters.install_type >>]
          steps:
            - fetch_job_artifact:
                job: "package extension"
                artifact: 'dd-library-php-[^"]+x86_64-linux-musl.tar.gz'
                directory: build/packages
            - fetch_job_artifact:
                job: "package extension"
                artifact: 'datadog-setup.php'
                directory: build/packages
      - when:
          condition:
            equal: [native_package, << parameters.install_type >>]
          steps:
            - fetch_job_artifact:
                job: "package extension"
                artifact: |-
                  datadog-php-tracer_[^"]+'"$(uname -m)"'.apk
                directory: build/packages
      - run:
          name: Validate alpine package
          command: ./dockerfiles/verify_packages/verify.sh

  verify_centos:
    working_directory: ~/datadog
    resource_class: small
    parameters:
      docker_image:
        type: string
      configuration:
        type: string
      php_package:
        type: string
        default: ""
      install_type:
        type: string
        # Possible values: php_installer, native_package
        default: php_installer
    docker:
      - image: << parameters.docker_image >>
        environment:
          PHP_PACKAGE: << parameters.php_package >>
          DD_AGENT_HOST: request-replayer
          DD_TRACE_AGENT_PORT: 80
          DD_TRACE_AGENT_FLUSH_INTERVAL: 1000
          INSTALL_TYPE: << parameters.install_type >>
          RUST_BACKTRACE: 1
      - <<: *IMAGE_DOCKER_REQUEST_REPLAYER
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Install git
          command: |
            # Fix yum config, as centos 7 is EOL and mirrorlist.centos.org does not resolve anymore
            # https://serverfault.com/a/1161847
            sed -i s/mirror.centos.org/vault.centos.org/g /etc/yum.repos.d/*.repo
            sed -i s/^#.*baseurl=http/baseurl=http/g /etc/yum.repos.d/*.repo
            sed -i s/^mirrorlist=http/#mirrorlist=http/g /etc/yum.repos.d/*.repo
            yum update -y
            yum install -y git
      - git_checkout
      - run: mkdir -p build/packages
      - when:
          condition:
            equal: [php_installer, << parameters.install_type >>]
          steps:
            - fetch_job_artifact:
                job: "package extension"
                artifact: 'dd-library-php-[^"]+x86_64-linux-gnu.tar.gz'
                directory: build/packages
            - fetch_job_artifact:
                job: "package extension"
                artifact: 'datadog-setup.php'
                directory: build/packages
      - when:
          condition:
            equal: [native_package, << parameters.install_type >>]
          steps:
            - fetch_job_artifact:
                job: "package extension"
                artifact: |-
                  datadog-php-tracer-[^"]+'"$(uname -m)"'.rpm
                directory: build/packages
      - run:
          name: Validate centos package
          command: << parameters.configuration >> ./dockerfiles/verify_packages/verify.sh

  verify_debian:
    working_directory: ~/datadog
    resource_class: small
    parameters:
      docker_image:
        type: string
      install_mode:
        type: string
      verify_apache:
        # yes|no
        type: string
        default: "yes"
      install_type:
        type: string
        # Possible values: php_installer, native_package
        default: php_installer
      configuration:
        type: string
    docker:
      - image: << parameters.docker_image >>
        environment:
          DD_AGENT_HOST: request-replayer
          DD_TRACE_AGENT_PORT: 80
          DD_TRACE_AGENT_FLUSH_INTERVAL: 1000
          VERIFY_APACHE: << parameters.verify_apache >>
          INSTALL_MODE: << parameters.install_mode >>
          INSTALL_TYPE: << parameters.install_type >>
          RUST_BACKTRACE: 1
      - <<: *IMAGE_DOCKER_REQUEST_REPLAYER
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Install git
          command: |
            apt-get update
            apt-get install -y git
      - run:
          name: Install curl
          command: |
            apt-get install -y curl
      - git_checkout
      - run: mkdir -p build/packages
      - when:
          condition:
            equal: [php_installer, << parameters.install_type >>]
          steps:
            - fetch_job_artifact:
                job: "package extension"
                artifact: 'dd-library-php-[^"]+x86_64-linux-gnu.tar.gz'
                directory: build/packages
            - fetch_job_artifact:
                job: "package extension"
                artifact: 'datadog-setup.php'
                directory: build/packages
      - when:
          condition:
            equal: [native_package, << parameters.install_type >>]
          steps:
            - fetch_job_artifact:
                job: "package extension"
                artifact: |-
                  datadog-php-tracer_[^"]+'"$(if [ $(uname -m) = "aarch64" ]; then echo arm64; else echo amd64; fi)"'.deb
                directory: build/packages
      - run:
          name: Validate debian package
          command: << parameters.configuration >> bash ./dockerfiles/verify_packages/verify.sh

  verify_tar_gz:
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        type: string
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - run:
          name: Install git
          command: |
            sudo apt-get update
            sudo apt-get install -y git
      - git_checkout
      - run: mkdir -p build/packages
      - fetch_job_artifact:
          job: "package extension"
          artifact: |-
            datadog-php-tracer-[^"]+'"$(uname -m)"'.tar.gz
          directory: build/packages
      - setup_docker:
          docker_image: debian:bullseye
      - run:
          name: Validate .tar.gz package
          command: PHP_VERSION=<< parameters.php_major_minor >> bash ./dockerfiles/verify_packages/verify_tar_gz_root.sh

  verify_no_json_ext:
    working_directory: ~/datadog
    resource_class: small
    docker:
      - image: alpine:3.12
    steps:
      - run:
          # see https://support.circleci.com/hc/en-us/articles/360016505753-Resolve-Certificate-Signed-By-Unknown-Authority-error-in-Alpine-images?flash_digest=39b76521a337cecacac0cc10cb28f3747bb5fc6a
          name: Install ca-certificates
          command: apk add --no-cache ca-certificates
      - run:
          name: Install git
          command: apk add git
      - run:
          name: Install curl
          command: apk add curl
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run: mkdir -p build/packages
      - fetch_job_artifact:
          job: "package extension"
          artifact: |-
            datadog-php-tracer_[^"]+'"$(uname -m)"'.apk
          directory: build/packages
      - run:
          name: Test
          command: ./dockerfiles/verify_packages/verify_no_ext_json.sh

  verify_windows:
    working_directory: ~/datadog
    resource_class: 'windows.medium'
    machine:
      image: 'windows-server-2019-vs2019:2022.08.1'
      shell: 'powershell.exe -ExecutionPolicy Bypass'
    parameters:
      docker_image:
        type: string
    steps:
      - git_checkout: { is_windows: true }
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Build nts
          shell: powershell.exe
          command: .\dockerfiles\verify_packages\verify_windows.ps1

  installer_tests:
    working_directory: ~/datadog
    machine:
      image: ubuntu-2004:2023.04.2
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - run:
          name: Let testing images to write to build/packages dir
          command: mkdir -p build/packages && chmod a+w build/packages

      - fetch_job_artifact:
          job: "package extension"
          artifact: 'dd-library-php-[^"]+x86_64-linux-gnu.tar.gz'
          directory: build/packages

      - fetch_job_artifact:
          job: "package extension"
          artifact: 'dd-library-php-[^"]+x86_64-linux-musl.tar.gz'
          directory: build/packages

      - fetch_job_artifact:
          job: "package extension"
          artifact: 'datadog-php-tracer-[^"]+x86_64.tar.gz'
          directory: build/packages

      - fetch_job_artifact:
          job: "package extension"
          artifact: "datadog-setup.php"
          directory: build/packages

      - run:
          name: Run tests
          command: make -C dockerfiles/verify_packages test_installer
          environment:
              RUST_BACKTRACE: 1

  randomized_tests:
    working_directory: ~/datadog
    machine:
      image: ubuntu-2004:2023.04.2
    resource_class: xlarge
    environment:
      - RANDOMIZED_RESTRICT_PLATFORMS: centos7
    parameters:
      batch:
        # Batch is only used to run a number of these jobs in parallel via a testing matrix.
        type: integer
      parent_job:
        type: string
        default: "package extension"
    steps: &randomized_tests_steps
      - run:
          name: Ensure enough memory via swapfile
          command: |
            sudo fallocate -l 16G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run:
          command: ls -al
      - run:
          name: Install required packages
          command: sudo apt update && sudo apt install -y php git
      - run:
          name: "Increase virtual memory limit for elasticsearch"
          command: sudo sysctl -w vm.max_map_count=262144
      - fetch_job_artifact:
          job: "<< parameters.parent_job >>"
          artifact: |-
            dd-library-php-[^"]+'"$(uname -m)"'-linux-gnu.tar.gz
      - run:
          name: Copy tracer package
          command: make -C tests/randomized library.local
      - run:
          name: Generate scenarios
          command: make -C tests/randomized generate PLATFORMS=$RANDOMIZED_RESTRICT_PLATFORMS NUMBER_OF_SCENARIOS=4
      - run:
          name: Execute tests
          command: make -C tests/randomized test CONCURRENT_JOBS=2 DURATION=1m30s
      - run:
          name: Fix PHP-FPM logs permissions before storing artifacts
          command: sudo chown -R circleci:circleci tests/randomized/.tmp.scenarios/.results
      - run:
          name: Analyze results
          command: make -C tests/randomized analyze
      - store_artifacts:
          path: 'tests/randomized/.tmp.scenarios/.results'

  randomized_tests_arm:
    working_directory: ~/datadog
    machine:
      image: ubuntu-2004:2023.04.2
    resource_class: arm.xlarge
    environment:
      - RANDOMIZED_RESTRICT_PLATFORMS: centos7
    parameters:
      batch:
        # Batch is only used to run a number of these jobs in parallel via a testing matrix.
        type: integer
      parent_job:
        type: string
        default: "package extension"
    steps: *randomized_tests_steps

  randomized_tests_asan:
    working_directory: ~/datadog
    machine:
      image: ubuntu-2004:2023.04.2
    resource_class: xlarge
    environment:
      - RANDOMIZED_RESTRICT_PLATFORMS: buster
    parameters:
      batch:
        # Batch is only used to run a number of these jobs in parallel via a testing matrix.
        type: integer
      parent_job:
        type: string
        default: "package extension zts-debug-asan"
    steps: *randomized_tests_steps

  randomized_tests_arm_asan:
    working_directory: ~/datadog
    machine:
      image: ubuntu-2004:2023.04.2
    resource_class: arm.xlarge
    environment:
      - RANDOMIZED_RESTRICT_PLATFORMS: buster
    parameters:
      batch:
        # Batch is only used to run a number of these jobs in parallel via a testing matrix.
        type: integer
      parent_job:
        type: string
        default: "package extension zts-debug-asan"
    steps: *randomized_tests_steps

  pecl_build:
    working_directory: ~/datadog
    executor:
      name: with_agent
      docker_image: "datadog/dd-trace-ci:php-7.4_buster"
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Make PECL build
          command: |
            make build_pecl_package
            mkdir -p ./pecl && cp datadog_trace-*.tgz ./pecl
      #- store_artifacts:
      #    path: pecl
      - persist_to_workspace:
          root: .
          paths: [pecl]

  pecl_tests:
    parameters:
      docker_image:
        type: string
      showdiff:
        type: boolean
        default: true
    working_directory: ~/datadog
    executor:
      name: with_httpbin_and_request_replayer
      docker_image: << parameters.docker_image >>
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Install from PECL build
          command: |
            cp ./pecl/datadog_trace-*.tgz ./datadog_trace.tgz
            sudo pecl install datadog_trace.tgz
            echo "extension=ddtrace.so" | sudo tee $(php -i | awk -F"=> " '/Scan this dir for additional .ini files/ {print $2}')/ddtrace.ini
            php --ri=ddtrace
      - <<: *STEP_WAIT_REQUEST_REPLAYER
      - <<: *STEP_RESOLVE_HTTPBIN_HOSTNAME_TO_IP
      - run:
          name: Run phpt tests with PECL
          command: |
            sudo \
            TERM=dumb \
            HTTPBIN_HOSTNAME=${HTTPBIN_HOSTNAME} \
            DATADOG_HAVE_DEV_ENV=1 \
            DD_TRACE_GIT_METADATA_ENABLED=0 \
            pecl run-tests <<# parameters.showdiff >> --showdiff <</ parameters.showdiff >> --ini=" -d datadog.trace.sources_path=" -p datadog_trace
      - run:
          name: Gather .diff files for artifacts
          command: |
            mkdir -p /tmp/artifacts
            find $(pecl config-get test_dir) -type f -name '*.diff' -exec cp --parents '{}' /tmp/artifacts \;
          when: on_fail
      - store_artifacts: { path: '/tmp/artifacts' }

  compile_rust_test:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: large
      triplet:
        type: string
      asan:
        type: boolean
        default: false
    <<: *BARE_DOCKER_MACHINE
    environment:
      - CARGO_TARGET_DIR: /mnt/ramdisk/cargo
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - restore_cache:
          name: Restore Cargo Package Cache
          keys:
            - cargo-cache-<< parameters.triplet >>-{{ checksum "Cargo.lock" }}
      - setup_docker:
          docker_image: datadog/dd-trace-ci:buster
          ramdisk: true
      - run:
          name: Compile sidecar
          command: |
            curl -LO https://github.com/libunwind/libunwind/releases/download/v1.8.1/libunwind-1.8.1.tar.gz
            tar -xvzf libunwind-1.8.1.tar.gz
            cd libunwind-1.8.1
            ./configure CFLAGS="-g -O3" --disable-tests
            make -j 8
            sudo make install
            cd ..
            <<# parameters.asan >>COMPILE_ASAN=1<</ parameters.asan >> SHARED=1 host_os=linux-gnu ./compile_rust.sh
            cp -v ${CARGO_TARGET_DIR:-target}/debug/libddtrace_php.a .
      - persist_to_workspace:
          root: '.'
          paths: [ './libddtrace_php.a' ]

  compile_extension_test:
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      resource_class:
        type: string
        default: medium
      switch_php_version:
        type: string
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-<< parameters.php_major_minor >>_buster
      - run:
          name: Build << parameters.switch_php_version >> extension
          command: |
            switch-php << parameters.switch_php_version >>
            make -j static
            cp -v tmp/build_extension/modules/ddtrace.a ddtrace.a
            cp -v tmp/build_extension/ddtrace.ldflags ddtrace.ldflags
      - persist_to_workspace:
          root: '.'
          paths: [ './ddtrace.a', 'ddtrace.ldflags' ]

  ExtensionComponents:
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      cmake_version:
        type: string
      catch2_version:
        type: string
    docker:
      - image: << parameters.docker_image >>
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Install cmake << parameters.cmake_version >>
          command: |
            if [ -d "/opt/cmake/<< parameters.cmake_version >>" ]
            then
              echo 'cmake << parameters.cmake_version >> already installed'
              exit 0
            fi

            if [ -e /etc/alpine-release ]
            then
              # We build from source on Alpine (slow)
              mkdir -p /tmp/cmake /opt/cmake/<< parameters.cmake_version >>
              cd /tmp/cmake
              curl -OL https://github.com/Kitware/CMake/releases/download/v<< parameters.cmake_version >>/cmake-<< parameters.cmake_version >>.tar.gz
              tar -xf *.tar.gz --strip 1
              ./bootstrap --prefix=/opt/cmake/<< parameters.cmake_version >> --parallel=2 && make -j 2 && make install
            else
              # We use prebuilt Linux packages everywhere else (fast)
              cd /tmp && curl -OL https://github.com/Kitware/CMake/releases/download/v<< parameters.cmake_version >>/cmake-<< parameters.cmake_version >>-Linux-x86_64.tar.gz
              mkdir -p /opt/cmake/<< parameters.cmake_version >>
              cd /opt/cmake/<< parameters.cmake_version >> && tar -xf /tmp/cmake-<< parameters.cmake_version >>-Linux-x86_64.tar.gz --strip 1
            fi

      - run:
          name: Install Catch2
          command: |
            if [ -d "/opt/catch2" ]
            then
              echo 'catch2 already installed'
              exit 0
            fi
            export PATH="/opt/cmake/<< parameters.cmake_version >>/bin:$PATH"
            cd /tmp
            curl -OL https://github.com/catchorg/Catch2/archive/v<< parameters.catch2_version >>.tar.gz
            mkdir catch2
            cd catch2
            tar -xf ../v<< parameters.catch2_version >>.tar.gz --strip 1
            cmake -Bbuild -H. -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=/opt/catch2
            cmake --build build/ --target install

      - run:
          name: Build and test Datadog::Php::Components (ASan)
          command: |
            export PATH="/opt/cmake/<< parameters.cmake_version >>/bin:$PATH"
            if [ -f "/opt/libuv/lib/pkgconfig/libuv.pc" ] ; then
              export PKG_CONFIG_PATH="/opt/libuv/lib/pkgconfig:$PKG_CONFIG_PATH"
            fi
            mkdir -p /tmp/build/datadog_php_components_asan
            cd /tmp/build/datadog_php_components_asan
            if [ -f "/etc/debian_version" ]
            then
              toolchain="-DCMAKE_TOOLCHAIN_FILE=~/datadog/cmake/asan.cmake"
            fi
            CMAKE_PREFIX_PATH=/opt/catch2 cmake \
              $toolchain \
              -DCMAKE_BUILD_TYPE=Debug \
              -DDATADOG_PHP_TESTING=ON \
              ~/datadog/components
            make -j all
            make test

      - run:
          name: Build and test Datadog::Php::Components (UBSan)
          command: |
            if [ ! -f "/etc/debian_version" ]
            then
              echo 'UBSan only supported on Buster for now'
              exit 0
            fi
            export PATH="/opt/cmake/<< parameters.cmake_version >>/bin:$PATH"
            mkdir -p /tmp/build/datadog_php_components_ubsan
            cd /tmp/build/datadog_php_components_ubsan
            CMAKE_PREFIX_PATH=/opt/catch2 cmake \
              -DCMAKE_TOOLCHAIN_FILE=~/datadog/cmake/ubsan.cmake \
              -DCMAKE_BUILD_TYPE=Debug \
              -DDATADOG_PHP_TESTING=ON \
              ~/datadog/components
            make -j all

            # channel is non-deterministic, so run tests a few more times. At
            # the moment, Catch2 tests are not automatically adding labels, so
            # run all tests instead of just channel's:
            # https://github.com/catchorg/Catch2/issues/1590
            make test ARGS="--output-on-failure --repeat until-fail:10"

      - run:
          command: |
            mkdir -p /tmp/artifacts
            cp /tmp/build/datadog_php_components_asan/Testing/Temporary/LastTest.log /tmp/artifacts/LastTestASan.log
            cp /tmp/build/datadog_php_components_ubsan/Testing/Temporary/LastTest.log /tmp/artifacts/LastTestUBSan.log
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts

  Tea:
    working_directory: ~/datadog
    parameters:
      os:
        type: string
      php_version:
        type: string
      cmake_version:
        type: string
      catch2_version:
        type: string
    docker:
      - image: datadog/dd-trace-ci:php-<< parameters.php_version >>_<< parameters.os >>
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Install cmake << parameters.cmake_version >>
          command: |
            if [ -d "/opt/cmake/<< parameters.cmake_version >>" ]
            then
              echo 'cmake << parameters.cmake_version >> already installed'
              exit 0
            fi
            cd /tmp && curl -OL https://github.com/Kitware/CMake/releases/download/v<< parameters.cmake_version >>/cmake-<< parameters.cmake_version >>-Linux-x86_64.tar.gz
            sudo mkdir -p /opt/cmake/<< parameters.cmake_version >>
            cd /opt/cmake/<< parameters.cmake_version >> && sudo tar -xf /tmp/cmake-<< parameters.cmake_version >>-Linux-x86_64.tar.gz --strip 1
            PATH="/opt/cmake/<< parameters.cmake_version >>/bin:$PATH"
      - run:
          name: Install Catch2
          command: |
            if [ -d "/opt/catch2" ]
            then
              echo 'catch2 already installed'
              exit 0
            fi
            cd /tmp
            curl -OL https://github.com/catchorg/Catch2/archive/v<< parameters.catch2_version >>.tar.gz
            mkdir catch2
            cd catch2
            tar -xf ../v<< parameters.catch2_version >>.tar.gz --strip 1
            cmake -Bbuild -H. -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=/opt/catch2
            cmake --build build/ --target install

      - run:
          name: TEA (build, test, & install on all PHP builds)
          command: |
            for phpBuild in $(ls /opt/php)
            do
              switch-php ${phpBuild}
              toolchain=""
              if [ "${phpBuild}" = "debug-zts-asan" ]
              then
                toolchain="-DCMAKE_TOOLCHAIN_FILE=~/datadog/cmake/asan.cmake"
              fi
              mkdir -p /tmp/build/tea-${phpBuild}
              cd /tmp/build/tea-${phpBuild}
              CMAKE_PREFIX_PATH=/opt/catch2 \
              cmake \
                ${toolchain} \
                -DCMAKE_INSTALL_PREFIX=/opt/tea/${phpBuild} \
                -DCMAKE_BUILD_TYPE=Debug \
                -DBUILD_TEA_TESTING=ON \
                ~/datadog/tea
              make -j all
              make test
              grep -e "=== Total [0-9]+ memory leaks detected ===" Testing/Temporary/LastTest.log && exit 1 || true
              make install
            done

      - run:
          name: Zend Abstract Interface (build & test on all PHP builds)
          command: |
            for phpBuild in $(ls /opt/php)
            do
              switch-php ${phpBuild}
              toolchain=""
              if [ "${phpBuild}" = "debug-zts-asan" ]
              then
                toolchain="-DCMAKE_TOOLCHAIN_FILE=~/datadog/cmake/asan.cmake"
              fi
              mkdir -p /tmp/build/zai-${phpBuild}
              cd /tmp/build/zai-${phpBuild}
              CMAKE_PREFIX_PATH=/opt/catch2 \
              Tea_ROOT=/opt/tea/${phpBuild} \
              cmake \
                ${toolchain} \
                -DCMAKE_BUILD_TYPE=Debug \
                -DBUILD_ZAI_TESTING=ON \
                -DPhpConfig_ROOT=$(php-config --prefix) \
                ~/datadog/zend_abstract_interface
              make -j all
              make test
              grep -e "=== Total [0-9]+ memory leaks detected ===" Testing/Temporary/LastTest.log && exit 1 || true
            done

      - when:
          condition: # PHP itself is only really ubsan compatible since 7.4
            not:
              or:
                - equal: [ "7.0", << parameters.php_version >> ]
                - equal: [ "7.1", << parameters.php_version >> ]
                - equal: [ "7.2", << parameters.php_version >> ]
                - equal: [ "7.3", << parameters.php_version >> ]
          steps:
            - run:
                name: Build and test Zend Abstract Interface (debug + UBSan)
                command: |
                  switch-php debug
                  mkdir -p /tmp/build/zai-debug-ubsan
                  cd /tmp/build/zai-debug-ubsan
                  CMAKE_PREFIX_PATH=/opt/catch2 \
                  Tea_ROOT=/opt/tea/debug \
                  cmake \
                    -DCMAKE_TOOLCHAIN_FILE=~/datadog/cmake/ubsan.cmake \
                    -DCMAKE_BUILD_TYPE=Debug \
                    -DBUILD_ZAI_TESTING=ON \
                    -DPhpConfig_ROOT=$(php-config --prefix) \
                    ~/datadog/zend_abstract_interface
                  make -j all
                  make test
                  grep -e "=== Total [0-9]+ memory leaks detected ===" Testing/Temporary/LastTest.log && exit 1 || true

      - run:
          name: Extension Tea Tests
          command: |
            for phpBuild in $(ls /opt/php)
            do
              switch-php ${phpBuild}
              toolchain=""
              if [ "${phpBuild}" = "debug-zts-asan" ]
              then
                toolchain="-DCMAKE_TOOLCHAIN_FILE=~/datadog/cmake/asan.cmake"
              fi

              # build ddtrace.so
              cd ~/datadog
              rm -rf tmp/build_extension
              make install

              # Build ext Tea tests
              builddir="/tmp/build/ext-tea-${phpBuild}"
              mkdir -p "${builddir}"
              cd "${builddir}"
              export CMAKE_PREFIX_PATH=/opt/catch2
              export Tea_ROOT=/opt/tea/${phpBuild}
              cmake ${toolchain} -DCMAKE_BUILD_TYPE=Debug -S ~/datadog/tests/tea
              cmake --build . --parallel
              make test ARGS="--output-on-failure"
              grep -e "=== Total [0-9]+ memory leaks detected ===" Testing/Temporary/LastTest.log && exit 1 || true
            done

      - run:
          command: |
            mkdir -p /tmp/artifacts
            cp --parents /tmp/build/zai-*/Testing/Temporary/LastTest.log /tmp/artifacts/
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts

  ZaiSharedExts:
    working_directory: ~/datadog
    parameters:
      php_version:
        type: string
    docker:
      - image: datadog/dd-trace-ci:php-<< parameters.php_version >>-shared-ext
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Switch PHP to nts
          command: |
            switch-php nts

      - run:
          name: TEA (build & install on nts)
          command: |
            mkdir -p /tmp/build/tea-nts
            cd /tmp/build/tea-nts
            CMAKE_PREFIX_PATH=/opt/catch2 \
            cmake \
              -DCMAKE_INSTALL_PREFIX=/opt/tea/nts \
              -DCMAKE_BUILD_TYPE=Debug \
              -DBUILD_TEA_TESTING=ON \
              -DPhpConfig_ROOT=$(php-config --prefix) \
              ~/datadog/tea
            make -j all
            make install

      # Starting in PHP 8.0, ext/json is a core extension
      - when:
          condition:
            or:
              - equal: [ "7.0", << parameters.php_version >> ]
              - equal: [ "7.1", << parameters.php_version >> ]
              - equal: [ "7.2", << parameters.php_version >> ]
              - equal: [ "7.3", << parameters.php_version >> ]
              - equal: [ "7.4", << parameters.php_version >> ]
          steps:
            - run:
                name: Ensure ext/json is loaded as shared lib
                command: |
                  if php --ri=json &> /dev/null
                  then
                    echo 'ext/json is enabled but should not be installed'
                    exit 1
                  fi
                  echo "extension=json.so" | sudo tee $(php -i | awk -F"=> " '/Scan this dir for additional .ini files/ {print $2}')/json.ini

      - run:
          name: Ensure ext/curl is loaded as shared lib
          command: |
            if php --ri=curl &> /dev/null
            then
              echo 'ext/curl is enabled but should not be installed'
              exit 1
            fi
            echo "extension=curl.so" | sudo tee $(php -i | awk -F"=> " '/Scan this dir for additional .ini files/ {print $2}')/curl.ini
      - run:
          name: Build and test Zend Abstract Interface (nts)
          command: |
            mkdir -p /tmp/build/zai-nts
            cd /tmp/build/zai-nts
            CMAKE_PREFIX_PATH=/opt/catch2 \
            Tea_ROOT=/opt/tea/nts \
            cmake \
              -DCMAKE_BUILD_TYPE=Debug \
              -DBUILD_ZAI_TESTING=ON \
              -DPhpConfig_ROOT=$(php-config --prefix) \
              -DRUN_SHARED_EXTS_TESTS=1 \
              ~/datadog/zend_abstract_interface
            make -j all
            TEA_INI_IGNORE=0 make test
            grep -e "=== Total [0-9]+ memory leaks detected ===" Testing/Temporary/LastTest.log && exit 1 || true

      - run:
          command: |
            mkdir -p /tmp/artifacts
            cp --parents /tmp/build/zai-*/Testing/Temporary/LastTest.log /tmp/artifacts/
          when: on_fail
      - store_artifacts:
          path: /tmp/artifacts

  compile_rust_alpine:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: large
      triplet:
        type: string
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - restore_cache:
          name: Restore Cargo Package Cache
          keys:
            - cargo-cache-<< parameters.triplet >>-{{ checksum "Cargo.lock" }}
      - append_build_id
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-compile-extension-alpine
      - run:
          name: Compile sidecar
          command: |
            # Workaround "error: failed to run custom build command for `aws-lc-sys v0.20.0`"
            cargo install --force --locked bindgen-cli
            export PATH="/root/.cargo/bin:$PATH"
            curl -LO https://github.com/libunwind/libunwind/releases/download/v1.8.1/libunwind-1.8.1.tar.gz
            tar -xvzf libunwind-1.8.1.tar.gz
            cd libunwind-1.8.1
            ./configure CFLAGS="-g -O3" --disable-tests
            make -j 8
            sudo make install
            cd ..
            SHARED=1 PROFILE=tracer-release host_os=linux-musl ./compile_rust.sh
            cp -v ${CARGO_TARGET_DIR:-target}/tracer-release/libddtrace_php.a libddtrace_php_$(uname -m)-alpine.a
            objcopy --compress-debug-sections ${CARGO_TARGET_DIR:-target}/tracer-release/libddtrace_php.so libddtrace_php_$(uname -m)-alpine.so
      - persist_to_workspace:
          root: '.'
          paths: [ './libddtrace_php_*.*' ]

  compile_alpine:
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: datadog/dd-trace-ci:php-compile-extension-alpine-<< parameters.php_major_minor >>
      - run: mkdir -p extensions_$(uname -m) standalone_$(uname -m)
      - run:
          name: Build nts extension
          command: |
            make -j static CFLAGS="-std=gnu11 -O2 -g -Wall -Wextra -Werror -Wno-error=return-local-addr" ECHO_ARG="-e"
            objcopy --compress-debug-sections tmp/build_extension/modules/ddtrace.so standalone_$(uname -m)/ddtrace-${PHP_API}-alpine.so
            cp -v tmp/build_extension/modules/ddtrace.a extensions_$(uname -m)/ddtrace-${PHP_API}-alpine.a
            if [ "<< parameters.php_major_minor >>" = "7.0" ]; then
              cp -v tmp/build_extension/ddtrace.ldflags ddtrace_$(uname -m)-alpine.ldflags
            fi
      - run:
          name: Build zts extension
          command: |
            . /root/.bashrc
            switch_php zts
            rm -r tmp/build_extension
            make -j static CFLAGS="-std=gnu11 -O2 -g -Wall -Wextra -Werror -Wno-error=return-local-addr" ECHO_ARG="-e"
            objcopy --compress-debug-sections tmp/build_extension/modules/ddtrace.so standalone_$(uname -m)/ddtrace-${PHP_API}-alpine-zts.so
            cp -v tmp/build_extension/modules/ddtrace.a extensions_$(uname -m)/ddtrace-${PHP_API}-alpine-zts.a
      - persist_to_workspace:
          root: '.'
          paths: [ './extensions_*', './standalone_*', 'ddtrace_*.ldflags' ]

  compile_extension_asan:
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      so_suffix:
        type: string
        default: unknown
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - run: mkdir -p extensions_$(uname -m)
      - run:
          name: Build extension basic .so
          command: |
            set -eo pipefail
            switch-php debug-zts-asan
            curl -LO https://github.com/libunwind/libunwind/releases/download/v1.8.1/libunwind-1.8.1.tar.gz
            tar -xvzf libunwind-1.8.1.tar.gz
            cd libunwind-1.8.1
            ./configure CFLAGS="-g -O3" --disable-tests
            make -j 8
            sudo make install
            cd ..
            make RUST_DEBUG_BUILD=1
            cp -v tmp/build_extension/modules/ddtrace.so extensions_$(uname -m)/ddtrace-<< parameters.so_suffix >>-debug-zts.so
      - run:
          name: Compress debug info
          command: |
            cd extensions_$(uname -m)
            for FILE in $(find . -name "*.so"); do
                objcopy --compress-debug-sections $FILE
            done
      - persist_to_workspace:
          root: '.'
          paths: ['./extensions_*']

  "cache cargo deps":
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      triplet:
        type: string
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - restore_cache:
          name: Restore Cargo Package Cache
          keys:
            - cargo-cache-<< parameters.triplet >>-{{ checksum "Cargo.lock" }}
      - run:
          name: cargo fetch
          command: |
            SUDO=$(! command -v sudo >/dev/null || echo "sudo -E")
            # On occasion, we've observed the .package-cache being in the cache.
            # If it's there, it will cause commands to stall, waiting for the file to be released.
            if [ -e '/rust/cargo/.package-cache' ] ; then
                echo "WARNING: .package-cache was part of the cache and shouldn't be!"
                $SUDO rm -vf '/rust/cargo/.package-cache'
            fi

            $SUDO mkdir /.cargo
            $SUDO chmod 777 /.cargo

            $SUDO cargo fetch -v --target << parameters.triplet >>
            $SUDO chmod -R 777 '/rust/cargo'

            # ensure the .package-cache isn't there
            $SUDO rm -vf '/rust/cargo/.package-cache'

      - save_cache:
          name: Save Cargo Package Cache
          key: cargo-cache-<< parameters.triplet >>-{{ checksum "Cargo.lock" }}
          paths:
            - /rust/cargo

  "cargo build --release":
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      abi_no:
        type: string
      triplet:
        type: string
      resource_class:
        type: string
        default: large # mostly for more RAM for ramdisk
    <<: *BARE_DOCKER_MACHINE
    environment:
      - CARGO_TARGET_DIR: /mnt/ramdisk/cargo
    steps:
      - git_checkout
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - restore_cache:
          name: Restore Cargo Package Cache
          keys:
            - cargo-cache-<< parameters.triplet >>-{{ checksum "profiling/Cargo.toml" }}
      - append_build_id
      - build_profiler:
          prefix: datadog-profiling/<< parameters.triplet >>/lib/php/<< parameters.abi_no >>
      - persist_to_workspace:
          root: .
          paths:
            - datadog-profiling

  "profiling tests":
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      triplet:
        type: string
      resource_class:
        type: string
        default: large # mostly for more RAM for ramdisk
    <<: *BARE_DOCKER_MACHINE
    environment:
      - CARGO_TARGET_DIR: /mnt/ramdisk/cargo
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - setup_docker:
          docker_image: << parameters.docker_image >>
          ramdisk: true
      - restore_cache:
          name: Restore Cargo Package Cache
          keys:
            - cargo-cache-<< parameters.triplet >>-{{ checksum "Cargo.lock" }}
      - run:
          name: cargo tests
          command: |
            if [ -d '/opt/rh/devtoolset-7' ] ; then
                set +eo pipefail
                source scl_source enable devtoolset-7
                set -eo pipefail
            fi
            set -u
            command -v switch-php && switch-php "${PHP_VERSION}"
            cd profiling
            cargo test --release --all-features
      - run:
          name: phpt tests NTS
          command: |
            set -u
            command -v switch-php && switch-php "${PHP_VERSION}"
            set -e
            libdir="/tmp/datadog-profiling"
            cd profiling
            cargo build --release --all-features
            cd tests
            # don't anticipate there being more than one
            run_tests_php=$(find $(php-config --prefix) -name run-tests.php)
            cp -v "${run_tests_php}" .
            export TEST_PHP_EXECUTABLE=$(which php)
            php run-tests.php -d "extension=/mnt/ramdisk/cargo/release/libdatadog_php_profiling.so" --show-diff -g "FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP" "phpt"
      - run:
          name: phpt tests ZTS
          command: |
            set -u
            command -v switch-php && switch-php "${PHP_VERSION}-zts"
            set -e
            libdir="/tmp/datadog-profiling"
            cd profiling
            touch build.rs #make sure `build.rs` gets executed after `switch-php` call
            cargo build --release --all-features
            cd tests
            # don't anticipate there being more than one
            run_tests_php=$(find $(php-config --prefix) -name run-tests.php)
            cp -v "${run_tests_php}" .
            export TEST_PHP_EXECUTABLE=$(which php)
            php run-tests.php -d "extension=/mnt/ramdisk/cargo/release/libdatadog_php_profiling.so" --show-diff -g "FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP" "phpt"

      - run:
          name: clippy NTS (for select platforms)
          command: |
            if [[ "x86_64-unknown-linux-gnu" != "<< parameters.triplet >>" ]] ; then
              exit 0
            fi
            set -u
            command -v switch-php && switch-php "${PHP_VERSION}"
            set -e
            cd profiling
            touch build.rs
            sed -i -e "s/crate-type.*$/crate-type = [\"rlib\"]/g" Cargo.toml
            cargo clippy --all-targets --all-features -- -D warnings -Aunknown-lints

  "compile_loader":
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      os:
        type: string
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - run:
          name: Compile the loader extension
          command: |
            set -xeuo pipefail

            if [[ "<< parameters.os >>" == "linux-musl" ]]; then
              apk add --no-cache \
                autoconf \
                coreutils \
                g++ \
                gcc \
                make
            fi

            cd loader
            phpize
            ./configure
            make clean
            make -j all ECHO_ARG="-e" CFLAGS="-std=gnu11 -O2 -g -Wall -Wextra -Werror -DPHP_DD_LIBRARY_LOADER_VERSION='\"$(cat ../VERSION)\"'"
            cp modules/dd_library_loader.so ../dd_library_loader-$(uname -m)-<< parameters.os >>.so
      - persist_to_workspace:
          root: '.'
          paths: [ './dd_library_loader-*.so' ]
      - store_artifacts:
          path: ./loader/modules/dd_library_loader.so

  "test_loader_linux":
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      php_major_minor:
        # Expected in the format: <major>.<minor>, e.g. 8.2
        type: string
      switch_php_version:
        type: string
        default: none
      use_valgrind:
        type: boolean
        default: false
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - fetch_job_artifact:
          job: "package extension"
          artifact: |-
            dd-library-php-ssi-[^"]+'"$(uname -m)"'-linux.tar.gz
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - switch_php:
          php_version: << parameters.switch_php_version >>
      - run:
          name: Test the loader
          command: |
            set -xeuo pipefail

            if [[ "<< parameters.php_major_minor >>" == "8.4" ]]; then
              export XDEBUG_SO_NAME=xdebug-3.4.0.so
            elif [[ "<< parameters.php_major_minor >>" == "8.3" ]]; then
              export XDEBUG_SO_NAME=xdebug-3.3.2.so
            elif [[ "<< parameters.php_major_minor >>" == "8.2" ]]; then
              export XDEBUG_SO_NAME=xdebug-3.2.2.so
            elif [[ "<< parameters.php_major_minor >>" == "8.1" ]]; then
              export XDEBUG_SO_NAME=xdebug-3.1.0.so
            elif [[ "<< parameters.php_major_minor >>" == "8.0" ]]; then
              export XDEBUG_SO_NAME=xdebug-3.0.0.so
            elif [[ "<< parameters.php_major_minor >>" == "7.4" ]]; then
              export XDEBUG_SO_NAME=xdebug-2.9.5.so
            fi

            rm -rf dd-library-php-ssi
            tar -xzf dd-library-php-ssi-*-linux.tar.gz
            export DD_LOADER_PACKAGE_PATH=${PWD}/dd-library-php-ssi

            cd loader
            mkdir -p modules
            cp ../dd-library-php-ssi/linux-gnu/loader/dd_library_loader.so modules/
            ./bin/test.sh
            if [[ "<< parameters.php_major_minor >>" == "8.3" ]]; then
              true
              <<# parameters.use_valgrind >>echo "Run with Valgrind" ; TEST_USE_VALGRIND=1 ./bin/test.sh<</ parameters.use_valgrind >>
            fi
            ./bin/check_glibc_version.sh

  "test_loader_alpine":
    working_directory: ~/datadog
    parameters:
      docker_image:
        type: string
      alpine_version:
        type: string
      alpine_packages:
        type: string
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - fetch_job_artifact:
          job: "package extension"
          artifact: |-
            dd-library-php-ssi-[^"]+'"$(uname -m)"'-linux.tar.gz
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - run:
          name: Test the loader
          command: |
            set -xeuo pipefail

            apk add --no-cache curl-dev << parameters.alpine_packages >>
            export XDEBUG_SO_NAME=xdebug.so

            rm -rf dd-library-php-ssi
            tar -xzf dd-library-php-ssi-*-linux.tar.gz
            export DD_LOADER_PACKAGE_PATH=${PWD}/dd-library-php-ssi

            cd loader
            mkdir -p modules
            cp ../dd-library-php-ssi/linux-musl/loader/dd_library_loader.so modules/
            ./bin/test.sh

  compile_rust_centos:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: large
      triplet:
        type: string
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - restore_cache:
          name: Restore Cargo Package Cache
          keys:
            - cargo-cache-<< parameters.triplet >>-{{ checksum "Cargo.lock" }}
      - append_build_id
      - setup_docker:
          docker_image: datadog/dd-trace-ci:centos-7
      - run:
          name: Compile sidecar
          command: |
            set +eo pipefail; source scl_source enable devtoolset-7; set -eo pipefail
            curl -LO https://github.com/libunwind/libunwind/releases/download/v1.8.1/libunwind-1.8.1.tar.gz
            tar -xvzf libunwind-1.8.1.tar.gz
            cd libunwind-1.8.1
            ./configure CFLAGS="-g -O3" --disable-tests
            make -j 8
            sudo make install
            cd ..
            SHARED=1 PROFILE=tracer-release host_os=linux-gnu ./compile_rust.sh
            cp -v ${CARGO_TARGET_DIR:-target}/tracer-release/libddtrace_php.a libddtrace_php_$(uname -m).a
            objcopy --compress-debug-sections ${CARGO_TARGET_DIR:-target}/tracer-release/libddtrace_php.so libddtrace_php_$(uname -m).so
      - persist_to_workspace:
          root: '.'
          paths: [ './libddtrace_php_*.*' ]

  compile_extension_centos:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: medium
      docker_image:
        type: string
      so_suffix:
        type: string
        default: unknown
      catch_warnings:
        type: boolean
        default: true
      php_version:
        type: string
      persist_ldflags:
        type: boolean
        default: false
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - run: mkdir -p extensions_$(uname -m) standalone_$(uname -m)
      - run:
          name: Build ndebug, nts configuration
          command: |
            set +eo pipefail; source scl_source enable devtoolset-7; set -eo pipefail
            switch-php << parameters.php_version >>
            make clean && make -j static ECHO_ARG="-e" CFLAGS="-std=gnu11 -O2 -g -Wall -Wextra <<# parameters.catch_warnings >> -Werror <</ parameters.catch_warnings >>"
            objcopy --compress-debug-sections tmp/build_extension/modules/ddtrace.so standalone_$(uname -m)/ddtrace-<< parameters.so_suffix >>.so
            cp -v tmp/build_extension/modules/ddtrace.a extensions_$(uname -m)/ddtrace-<< parameters.so_suffix >>.a
            <<# parameters.persist_ldflags >> cp -v tmp/build_extension/ddtrace.ldflags ddtrace_$(uname -m).ldflags <</ parameters.persist_ldflags >>
      - run:
          name: Build debug, nts configuration
          command: |
            set +eo pipefail; source scl_source enable devtoolset-7; set -eo pipefail
            switch-php << parameters.php_version >>-debug
            make clean && make -j static ECHO_ARG="-e" CFLAGS="-std=gnu11 -O0 -g -Wall -Wextra <<# parameters.catch_warnings >> -Werror <</ parameters.catch_warnings >>"
            objcopy --compress-debug-sections tmp/build_extension/modules/ddtrace.so standalone_$(uname -m)/ddtrace-<< parameters.so_suffix >>-debug.so
            cp -v tmp/build_extension/modules/ddtrace.a extensions_$(uname -m)/ddtrace-<< parameters.so_suffix >>-debug.a
      - run:
          name: Build zts configuration
          command: |
            set +eo pipefail; source scl_source enable devtoolset-7; set -eo pipefail
            switch-php << parameters.php_version >>-zts
            make clean && make -j static ECHO_ARG="-e" CFLAGS="-std=gnu11 -O2 -g -Wall -Wextra <<# parameters.catch_warnings >> -Werror <</ parameters.catch_warnings >>"
            objcopy --compress-debug-sections tmp/build_extension/modules/ddtrace.so standalone_$(uname -m)/ddtrace-<< parameters.so_suffix >>-zts.so
            cp -v tmp/build_extension/modules/ddtrace.a extensions_$(uname -m)/ddtrace-<< parameters.so_suffix >>-zts.a
      - persist_to_workspace:
          root: '.'
          paths: [ './extensions_*', './standalone_*', 'ddtrace_*.ldflags' ]

  link_extension:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: xlarge
      docker_image:
        type: string
      libddtrace_suffix:
        type: string
        default: ""
    <<: *BARE_DOCKER_MACHINE
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - setup_docker:
          docker_image: << parameters.docker_image >>
      - run:
          name: Link sidecar and extension
          command: |
            sed -i 's/-export-symbols .*\/ddtrace\.sym/-Wl,--retain-symbols-file=ddtrace.sym/g' ddtrace_$(uname -m)<< parameters.libddtrace_suffix >>.ldflags
            pids=()
            for archive in extensions_$(uname -m)/*.a; do
              (
                cc -shared -Wl,-whole-archive $archive -Wl,-no-whole-archive $(cat ddtrace_$(uname -m)<< parameters.libddtrace_suffix >>.ldflags) libddtrace_php_$(uname -m)<< parameters.libddtrace_suffix >>.a -Wl,-soname -Wl,ddtrace.so -o ${archive%.a}.so
                objcopy --compress-debug-sections ${archive%.a}.so
              ) &
              pids+=($!)
            done
            for pid in "${pids[@]}"; do
              wait $pid
            done
      - persist_to_workspace:
          root: '.'
          paths: [ './extensions_*' ]

  compile_extension_windows:
    working_directory: ~/datadog
    resource_class: 'windows.medium'
    machine:
      image: 'windows-server-2019-vs2019:2022.08.1'
      shell: 'powershell.exe -ExecutionPolicy Bypass'
    parameters:
      docker_image:
        type: string
      so_suffix:
        type: string
        default: unknown
      php_version:
        type: string
    steps:
      - git_checkout: { is_windows: true }
      - append_build_id:
          shell: bash.exe
      - run:
          name: Setup docker container
          shell: powershell.exe
          command: |
            mkdir extensions_x86_64
            mkdir extensions_x86_64_debugsymbols
            # No DNS for you by default in circleci docker containers
            docker network create -d "nat" -o com.docker.network.windowsshim.dnsservers="1.1.1.1" net
            docker run -v ${pwd}:C:\Users\ContainerAdministrator\app -d --network net --name php << parameters.docker_image >> ping -t localhost
      - run:
          name: Build nts
          shell: powershell.exe
          command: |
            docker exec php powershell.exe "cd app; switch-php nts; C:\php\SDK\phpize.bat; .\configure.bat --enable-debug-pack; nmake; move x64\Release\php_ddtrace.dll extensions_x86_64\php_ddtrace-<< parameters.so_suffix >>.dll; move x64\Release\php_ddtrace.pdb extensions_x86_64_debugsymbols\php_ddtrace-<< parameters.so_suffix >>.pdb"
      - run:
          name: Reuse libdatadog build
          shell: powershell.exe
          command: |
            docker exec php powershell.exe "mkdir app\x64\Release_TS; mv app\x64\Release\target app\x64\Release_TS\target"
      - run:
          name: Build zts
          shell: powershell.exe
          command: |
            docker exec php powershell.exe "cd app; switch-php zts; C:\php\SDK\phpize.bat; .\configure.bat --enable-debug-pack; nmake; move x64\Release_TS\php_ddtrace.dll extensions_x86_64\php_ddtrace-<< parameters.so_suffix >>-zts.dll; move x64\Release_TS\php_ddtrace.pdb extensions_x86_64_debugsymbols\php_ddtrace-<< parameters.so_suffix >>-zts.pdb"
      - persist_to_workspace:
          root: '.'
          paths: [ './extensions_x86_64', './extensions_x86_64_debugsymbols' ]

  compile_appsec_extension_centos:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: medium
      php_version:
        type: string
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: "datadog/dd-trace-ci:php-<< parameters.php_version >>_centos-7"
      - run: mkdir -p appsec_$(uname -m)
      - run:
          name: Install cmake 3.24.4
          command: |
            if [ ! -d "/opt/cmake/3.24.4" ]
            then
              cd /tmp && curl -OL https://github.com/Kitware/CMake/releases/download/v3.24.4/cmake-3.24.4-Linux-$(uname -m).tar.gz
              mkdir -p /opt/cmake/3.24.4
              cd /opt/cmake/3.24.4 && tar -xf /tmp/cmake-3.24.4-Linux-$(uname -m).tar.gz --strip 1
            fi
            echo 'export PATH="/opt/cmake/3.24.4/bin:$PATH"' >> "$BASH_ENV"
            echo 'export PHP_API=$(php -i | grep "PHP Extension => " | sed "s/PHP Extension => //g")' >> "$BASH_ENV"
            source "$BASH_ENV"
      - run:
          name: Build ndebug, nts configuration
          command: |
            set +eo pipefail; source scl_source enable devtoolset-7; set -eo pipefail
            switch-php << parameters.php_version >>
            mkdir -p appsec/build-release ; cd appsec/build-release
            cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DDD_APPSEC_BUILD_HELPER=OFF  -DDD_APPSEC_TESTING=OFF ; make -j $(nproc)
            cp -v ddappsec.so ../../appsec_$(uname -m)/ddappsec-$PHP_API.so
      - run:
          name: Build ndebug, zts configuration
          command: |
            set +eo pipefail; source scl_source enable devtoolset-7; set -eo pipefail
            switch-php << parameters.php_version >>-zts
            mkdir -p appsec/build-release-zts ; cd appsec/build-release-zts
            cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DDD_APPSEC_BUILD_HELPER=OFF  -DDD_APPSEC_TESTING=OFF ; make -j $(nproc)
            cp -v ddappsec.so ../../appsec_$(uname -m)/ddappsec-$PHP_API-zts.so
      - run:
          name: Compress debug info
          command: |
            cd appsec_$(uname -m)
            for FILE in $(find . -name "*.so"); do
                objcopy --compress-debug-sections $FILE
            done
      - persist_to_workspace:
          root: '.'
          paths: [ './appsec_*' ]

  compile_appsec_extension_alpine:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: medium
      php_version:
        type: string
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-<< parameters.php_version >>"
      - run: mkdir -p appsec_$(uname -m)
      - run:
          name: Install dependencies
          command: |
            apk add cmake gcc g++ git python3 autoconf coreutils
            echo 'export PHP_API=$(php -i | grep "PHP Extension => " | sed "s/PHP Extension => //g")' >> "$BASH_ENV"
            source "$BASH_ENV"
      - run:
          name: Build nts extension
          command: |
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DDD_APPSEC_BUILD_HELPER=OFF  -DDD_APPSEC_TESTING=OFF ; make -j $(nproc)
            cp -v ddappsec.so ../../appsec_$(uname -m)/ddappsec-$PHP_API-alpine.so
      - run:
          name: Build zts extension
          command: |
            . /root/.bashrc
            switch_php zts
            mkdir -p appsec/build-zts ; cd appsec/build-zts
            cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DDD_APPSEC_BUILD_HELPER=OFF  -DDD_APPSEC_TESTING=OFF ; make -j $(nproc)
            cp -v ddappsec.so ../../appsec_$(uname -m)/ddappsec-$PHP_API-alpine-zts.so
      - run:
          name: Compress debug info
          command: |
            cd appsec_$(uname -m)
            for FILE in $(find . -name "*.so"); do
                objcopy --compress-debug-sections $FILE
            done
      - persist_to_workspace:
          root: '.'
          paths: [ './appsec_*' ]

  compile_appsec_helper:
    working_directory: ~/datadog
    parameters:
      resource_class:
        type: string
        default: medium
    <<: *BARE_DOCKER_MACHINE
    steps:
      - git_checkout
      - append_build_id
      - setup_docker:
          docker_image: "public.ecr.aws/b1o7r7e0/nginx_musl_toolchain"
      - run: mkdir -p appsec_$(uname -m)
      - run:
          name: Build
          command: |
            git config --global --add safe.directory $(pwd)/appsec/third_party/libddwaf
            mkdir -p appsec/build ; cd appsec/build
            cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DDD_APPSEC_BUILD_EXTENSION=OFF \
              -DDD_APPSEC_ENABLE_PATCHELF_LIBC=ON \
              -DCMAKE_TOOLCHAIN_FILE=/sysroot/$(arch)-none-linux-musl/Toolchain.cmake
            make -j $(nproc)
            objcopy --compress-debug-sections libddappsec-helper.so
            cp -v libddappsec-helper.so ../../appsec_$(uname -m)/libddappsec-helper.so
      - run:
          name: Test
          command: |
            cd appsec/build
            make -j $(nproc) ddappsec_helper_test
            ./tests/helper/ddappsec_helper_test
      - run:
          name: Copy ruleset
          command: |
            cd appsec
            cp recommended.json ../appsec_$(uname -m)/
      - persist_to_workspace:
          root: '.'
          paths: [ './appsec_*' ]

  "Prepare Code":
    working_directory: ~/datadog
    docker: [ image: 'cimg/php:7.3' ]
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
            - source-v1-{{ .Branch }}-
            - source-v1-
      - git_checkout
      - save_cache:
          key: source-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - ".git"
      - <<: *STEP_ATTACH_WORKSPACE
      - append_build_id
      - <<: *STEP_COMPOSER_SELF_UPDATE
      - <<: *STEP_COMPOSER_UPDATE
      - <<: *STEP_COMPOSER_GENERATE
      - run:
          name: Showing folder containing generated files
          command: ls -al ~/datadog/src/bridge
      - persist_to_workspace:
          root: '.'
          paths:
            - './src/bridge/_generated*.php'
            - './VERSION' # we generate a new version number

  "package extension":
    working_directory: ~/datadog
    docker: [ image: 'datadog/dd-trace-ci:php_fpm_packaging' ]
    parameters:
      asan_build:
        type: boolean
        default: false
    resource_class: xlarge
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - <<: *STEP_ATTACH_WORKSPACE
      - run:
          name: Build packages
          command: |
            <<# parameters.asan_build >>export DDTRACE_MAKE_PACKAGES_ASAN=1<</ parameters.asan_build >>
            make -j9 calculate_package_sha256_sums packages
      - run:
          name: Display sha256sums
          command: cat package_sha256sums
      - run:
          name: Spot-check shape of library name
          command: |
            version=$(cat VERSION)
            filename="dd-library-php-${version}-x86_64-linux-gnu.tar.gz"
            if ! [[ -f "build/packages/$filename" ]] ; then
              echo "Expected file 'build/packages/$filename' to exist!"
              exit 1
            fi

            if ! [[ "$CIRCLE_BRANCH" =~ "ddtrace-" ]] ; then
              githash="${CIRCLE_SHA1?}"
              echo "Non-release branch detected. Checking for git sha1: $githash."
              if echo "$filename" | grep -q "+$githash" ; then
                echo "Confirmed: '$filename' contains git sha1 hash '$githash'."
              else
                echo "'$filename' didn't contain git sha1 hash '$githash'."
                exit 1
              fi
            fi

      - store_artifacts: { path: 'build/packages', destination: / }
      - store_artifacts: { path: 'packages.tar.gz', destination: '/all/packages.tar.gz' }
      - store_artifacts: { path: 'pecl', destination: '/pecl' }

  "x-profiling phpt tests on Alpine":
    working_directory: ~/datadog
    parameters:
      php_major_minor:
        type: string
    docker:
      - image: datadog/dd-trace-ci:php-compile-extension-alpine-<< parameters.php_major_minor >>
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run:
          name: Install curl
          command: apk add curl
      - fetch_job_artifact:
          job: "package extension"
          artifact: 'dd-library-php-[^"]+x86_64-linux-musl.tar.gz'
      - fetch_job_artifact:
          job: "package extension"
          artifact: 'datadog-setup.php'
      - run:
          name: Run cross-product profiling phpt tests
          command: |
              set -eu
              apk update
              apk add autoconf coreutils gcc make
              installable_bundle=$(find . -maxdepth 1 -name 'dd-library-php-*-x86_64-linux-musl.tar.gz')
              php datadog-setup.php --file "${installable_bundle}" --php-bin php --enable-profiling
              # run phpize just to get run-tests.php
              phpize
              php run-tests.php -p $(which php) -d datadog.remote_config_enabled=false --show-diff -g "FAIL,XFAIL,BORK,WARN,LEAK,XLEAK,SKIP" tests/ext/profiling

  "generated files up-to-date":
    working_directory: ~/datadog
    docker:
      - image: datadog/dd-trace-ci:php-8.3_buster
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout
      - run:
          name: Install cbindgen
          command: cargo install --version "^0.26" cbindgen
      - run:
          name: Regenerate cbindgen headers and compare them
          command: |
            set -eu
            make cbindgen
            git diff --exit-code components-rs
      - run:
          name: Regenerate PHP stubs and compare them
          command: |
            set -eu
            make generate_stubs
            git diff --exit-code src/ddtrace_php_api.stubs.php
      - run:
          name: Ensure no non-bundled rust git dependencies are used
          command: |
            set -eu
            ! grep -P 'source = "git+(?!.*libdatadog)' Cargo.lock

  placeholder:
    docker:
      - image: busybox
    steps:
      - run: echo "."

  system_tests:
    machine:
      image: ubuntu-2404:2024.05.1
    parameters:
      build:
        type: string
      run:
        type: string
    resource_class: large
    working_directory: ~/datadog
    steps:
      - restore_cache:
          keys:
            - source-v1-{{ .Branch }}-{{ .Revision }}
      - git_checkout

      - run:
          name: Install python 3.12
          command: |
            sudo apt-get update
            sudo apt-get install -y python3.12-full python3.12-dev python3.12-venv

      - run:
          name: versions
          command: |
            docker --version
            docker-compose --version
      - run:
          name: Clone System Tests repo
          command: git clone https://github.com/DataDog/system-tests.git

      - fetch_job_artifact:
          job: "package extension"
          artifact: 'dd-library-php-[^"]+x86_64-linux-gnu.tar.gz'
          directory: system-tests/binaries

      - fetch_job_artifact:
          job: "package extension"
          artifact: "datadog-setup.php"
          directory: system-tests/binaries

      - run:
          name: Build
          command: << parameters.build >>
      - run:
          name: Run
          command: << parameters.run >>
      - store_artifacts:
          path: system-tests/logs
          destination: system-tests.tar.gz

workflows:
  version: 2

  components-c:
    when: << pipeline.parameters.components-c >>
    jobs:
      # We need to prepare code because centos 6's git is too old for CircleCI, true story:
      # > error: unknown switch `B'
      - "Prepare Code"
      - ExtensionComponents:
          requires: [ 'Prepare Code' ]
          matrix:
            parameters:
              docker_image:
                # Don't need PHP, just basic toolchain
                - "datadog/dd-trace-ci:centos-7"
                - "datadog/dd-trace-ci:alpine"
                - "datadog/dd-trace-ci:buster"
              cmake_version:
                - "3.24.4"
              catch2_version:
                - "2.13.10"

  zend_abstract_interface:
    when: << pipeline.parameters.zend_abstract_interface >>
    jobs:
      - "Prepare Code"
      - Tea:
          requires: [ 'Prepare Code' ]
          matrix:
            parameters:
              os:
                # TODO Add CentOS & Alpine
                - "buster"
              php_version:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              cmake_version:
                - "3.24.4"
              catch2_version:
                - "2.13.10"

  zend_abstract_interface_shared_exts:
    when: << pipeline.parameters.zend_abstract_interface >>
    jobs:
      - "Prepare Code"
      - ZaiSharedExts:
          requires: [ 'Prepare Code' ]
          matrix:
            parameters:
              php_version:
                - "7.4"
                - "8.0"

  build_packages:
    when: << pipeline.parameters.build >>
    jobs:
      - "Prepare Code"

      # In the event the cache is broken, all cargo jobs will end up fetching
      # dependencies. Although this is a bit wasteful, when the cache isn't
      # broken this saves us about 30+ secs of build time on the critical path.
      # Since the tracer folks are unlikely to break the cache, they will save
      # time in their CI cycles and only profiler folks will have to pay.
      - "cache cargo deps":
          name: "cache cargo deps - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.1"
          triplet: "x86_64-alpine-linux-musl"
      - "cache cargo deps":
          name: "cache cargo deps - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.1"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.1 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.1"
          abi_no: "20160303"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v7.1 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.1"
          abi_no: "20160303"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.2 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.2"
          abi_no: "20170718"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v7.2 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.2"
          abi_no: "20170718"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.3 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.3"
          abi_no: "20180731"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v7.3 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.3"
          abi_no: "20180731"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.4 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.4"
          abi_no: "20190902"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v7.4 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.4"
          abi_no: "20190902"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.0 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.0"
          abi_no: "20200930"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v8.0 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.0"
          abi_no: "20200930"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.1 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.1"
          abi_no: "20210902"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v8.1 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.1"
          abi_no: "20210902"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.2 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.2"
          abi_no: "20220829"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v8.2 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.2"
          abi_no: "20220829"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.3 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.3"
          abi_no: "20230831"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v8.3 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.3"
          abi_no: "20230831"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.4 - x86_64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.4"
          abi_no: "20240924"
          triplet: "x86_64-alpine-linux-musl"
      - "cargo build --release":
          name: "Profiler PHP v8.4 - aarch64-alpine-linux-musl"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.4"
          abi_no: "20240924"
          triplet: "aarch64-alpine-linux-musl"
          resource_class: "arm.medium"

      - "cache cargo deps":
          name: "cache cargo deps - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:centos-7"
          triplet: "x86_64-unknown-linux-gnu"
      - "cache cargo deps":
          name: "cache cargo deps - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:centos-7"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.1 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.1_centos-7"
          abi_no: "20160303"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v7.1 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.1_centos-7"
          abi_no: "20160303"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.2 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.2_centos-7"
          abi_no: "20170718"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v7.2 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.2_centos-7"
          abi_no: "20170718"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.3 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.3_centos-7"
          abi_no: "20180731"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v7.3 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.3_centos-7"
          abi_no: "20180731"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v7.4 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.4_centos-7"
          abi_no: "20190902"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v7.4 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-7.4_centos-7"
          abi_no: "20190902"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.0 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.0_centos-7"
          abi_no: "20200930"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v8.0 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.0_centos-7"
          abi_no: "20200930"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.1 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.1_centos-7"
          abi_no: "20210902"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v8.1 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.1_centos-7"
          abi_no: "20210902"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.2 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.2_centos-7"
          abi_no: "20220829"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v8.2 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.2_centos-7"
          abi_no: "20220829"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.3 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.3_centos-7"
          abi_no: "20230831"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v8.3 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.3_centos-7"
          abi_no: "20230831"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"
      - "cargo build --release":
          name: "Profiler PHP v8.4 - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.4_centos-7"
          abi_no: "20240924"
          triplet: "x86_64-unknown-linux-gnu"
      - "cargo build --release":
          name: "Profiler PHP v8.4 - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:php-8.4_centos-7"
          abi_no: "20240924"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"

      - compile_appsec_extension_centos:
          matrix:
            parameters:
              php_version:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
              resource_class:
                - "medium"
                - "arm.medium"

      - compile_appsec_extension_alpine:
          matrix:
            parameters:
              php_version:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
              resource_class:
                - "medium"
                - "arm.medium"

      - compile_appsec_helper:
          matrix:
            parameters:
              resource_class:
                - "medium"
                - "arm.medium"

      - compile_alpine:
          matrix:
            parameters:
              php_major_minor:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
          resource_class: "medium"
          name: "Compile alpine x86_64 PHP << matrix.php_major_minor >>"
      - compile_alpine:
          matrix:
            parameters:
              php_major_minor:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
          resource_class: "arm.medium"
          name: "Compile alpine aarch64 PHP << matrix.php_major_minor >>"
      - compile_rust_alpine:
          name: "Compile alpine x86_64 rust"
          resource_class: medium
          triplet: "x86_64-alpine-linux-musl"
      - compile_rust_alpine:
          name: "Compile alpine aarch64 rust"
          resource_class: arm.medium
          triplet: "aarch64-alpine-linux-musl"
      - link_extension:
          requires:
            - "Compile alpine x86_64 rust"
            - "Compile alpine x86_64 PHP 7.0"
            - "Compile alpine x86_64 PHP 7.1"
            - "Compile alpine x86_64 PHP 7.2"
            - "Compile alpine x86_64 PHP 7.3"
            - "Compile alpine x86_64 PHP 7.4"
            - "Compile alpine x86_64 PHP 8.0"
            - "Compile alpine x86_64 PHP 8.1"
            - "Compile alpine x86_64 PHP 8.2"
            - "Compile alpine x86_64 PHP 8.3"
            - "Compile alpine x86_64 PHP 8.4"
          libddtrace_suffix: "-alpine"
          resource_class: "large"
          name: "Link x86_64 alpine"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine"
      - link_extension:
          requires:
            - "Compile alpine aarch64 rust"
            - "Compile alpine aarch64 PHP 7.0"
            - "Compile alpine aarch64 PHP 7.1"
            - "Compile alpine aarch64 PHP 7.2"
            - "Compile alpine aarch64 PHP 7.3"
            - "Compile alpine aarch64 PHP 7.4"
            - "Compile alpine aarch64 PHP 8.0"
            - "Compile alpine aarch64 PHP 8.1"
            - "Compile alpine aarch64 PHP 8.2"
            - "Compile alpine aarch64 PHP 8.3"
            - "Compile alpine aarch64 PHP 8.4"
          libddtrace_suffix: "-alpine"
          resource_class: "arm.large"
          name: "Link aarch64 alpine"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 70 nts + zts + debug"
          php_version: "7.0"
          docker_image: "datadog/dd-trace-ci:php-7.0_centos-7"
          so_suffix: "20151012"
          persist_ldflags: true
      - compile_extension_centos:
          name: "Compile aarch64 PHP 70 nts + zts + debug"
          php_version: "7.0"
          docker_image: "datadog/dd-trace-ci:php-7.0_centos-7"
          so_suffix: "20151012"
          persist_ldflags: true
          resource_class: "arm.medium"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 71 nts + zts + debug"
          php_version: "7.1"
          docker_image: "datadog/dd-trace-ci:php-7.1_centos-7"
          so_suffix: "20160303"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 71 nts + zts + debug"
          php_version: "7.1"
          docker_image: "datadog/dd-trace-ci:php-7.1_centos-7"
          so_suffix: "20160303"
          resource_class: "arm.medium"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 72 nts + zts + debug"
          php_version: "7.2"
          docker_image: "datadog/dd-trace-ci:php-7.2_centos-7"
          so_suffix: "20170718"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 72 nts + zts + debug"
          php_version: "7.2"
          docker_image: "datadog/dd-trace-ci:php-7.2_centos-7"
          so_suffix: "20170718"
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 72 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-7.2_windows"
          php_version: "7.2"
          so_suffix: "20170718"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 73 nts + zts + debug"
          php_version: "7.3"
          docker_image: "datadog/dd-trace-ci:php-7.3_centos-7"
          so_suffix: "20180731"
          catch_warnings: false # On debug builds: unused parameter '__zend_filename'
      - compile_extension_centos:
          name: "Compile aarch64 PHP 73 nts + zts + debug"
          php_version: "7.3"
          docker_image: "datadog/dd-trace-ci:php-7.3_centos-7"
          so_suffix: "20180731"
          catch_warnings: false # On debug builds: unused parameter '__zend_filename'
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 73 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-7.3_windows"
          php_version: "7.3"
          so_suffix: "20180731"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 74 nts + zts + debug"
          php_version: "7.4"
          docker_image: "datadog/dd-trace-ci:php-7.4_centos-7"
          so_suffix: "20190902"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 74 nts + zts + debug"
          php_version: "7.4"
          docker_image: "datadog/dd-trace-ci:php-7.4_centos-7"
          so_suffix: "20190902"
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 74 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-7.4_windows"
          php_version: "7.4"
          so_suffix: "20190902"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 80 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.0_centos-7"
          php_version: "8.0"
          so_suffix: "20200930"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 80 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.0_centos-7"
          php_version: "8.0"
          so_suffix: "20200930"
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 80 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-8.0_windows"
          php_version: "8.0"
          so_suffix: "20200930"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 81 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.1_centos-7"
          php_version: "8.1"
          so_suffix: "20210902"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 81 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.1_centos-7"
          php_version: "8.1"
          so_suffix: "20210902"
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 81 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-8.1_windows"
          php_version: "8.1"
          so_suffix: "20210902"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 82 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.2_centos-7"
          php_version: "8.2"
          so_suffix: "20220829"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 82 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.2_centos-7"
          php_version: "8.2"
          so_suffix: "20220829"
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 82 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-8.2_windows"
          php_version: "8.2"
          so_suffix: "20220829"
      - compile_extension_centos:
          name: "Compile x86_64 PHP 83 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.3_centos-7"
          php_version: "8.3"
          so_suffix: "20230831"
      - compile_extension_centos:
          name: "Compile aarch64 PHP 83 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.3_centos-7"
          php_version: "8.3"
          so_suffix: "20230831"
          resource_class: "arm.medium"
      - compile_extension_windows:
          name: "Compile Windows PHP 83 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-8.3_windows"
          php_version: "8.3"
          so_suffix: "20230831"
      - compile_extension_centos:
          requires: [ 'Prepare Code' ]
          name: "Compile x86_64 PHP 84 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.4_centos-7"
          php_version: "8.4"
          so_suffix: "20240924"
      - compile_extension_centos:
          requires: [ 'Prepare Code' ]
          name: "Compile aarch64 PHP 84 nts + zts + debug"
          docker_image: "datadog/dd-trace-ci:php-8.4_centos-7"
          php_version: "8.4"
          so_suffix: "20240924"
          resource_class: "arm.medium"
      - compile_extension_windows:
          requires: [ 'Prepare Code' ]
          name: "Compile Windows PHP 84 nts + zts"
          docker_image: "datadog/dd-trace-ci:php-8.4_windows"
          php_version: "8.4"
          so_suffix: "20240924"

      - compile_rust_centos:
          name: "Compile x86_64 rust"
          triplet: "x86_64-unknown-linux-gnu"
      - compile_rust_centos:
          name: "Compile aarch64 rust"
          resource_class: "arm.large"
          triplet: "aarch64-unknown-linux-gnu"

      - link_extension:
          requires:
            - "Compile x86_64 rust"
            - "Compile x86_64 PHP 70 nts + zts + debug"
            - "Compile x86_64 PHP 71 nts + zts + debug"
            - "Compile x86_64 PHP 72 nts + zts + debug"
            - "Compile x86_64 PHP 73 nts + zts + debug"
            - "Compile x86_64 PHP 74 nts + zts + debug"
            - "Compile x86_64 PHP 80 nts + zts + debug"
            - "Compile x86_64 PHP 81 nts + zts + debug"
            - "Compile x86_64 PHP 82 nts + zts + debug"
            - "Compile x86_64 PHP 83 nts + zts + debug"
            - "Compile x86_64 PHP 84 nts + zts + debug"
          name: "Link x86_64 PHP"
          docker_image: "datadog/dd-trace-ci:centos-7"
      - link_extension:
          requires:
            - "Compile aarch64 rust"
            - "Compile aarch64 PHP 70 nts + zts + debug"
            - "Compile aarch64 PHP 71 nts + zts + debug"
            - "Compile aarch64 PHP 72 nts + zts + debug"
            - "Compile aarch64 PHP 73 nts + zts + debug"
            - "Compile aarch64 PHP 74 nts + zts + debug"
            - "Compile aarch64 PHP 80 nts + zts + debug"
            - "Compile aarch64 PHP 81 nts + zts + debug"
            - "Compile aarch64 PHP 82 nts + zts + debug"
            - "Compile aarch64 PHP 83 nts + zts + debug"
            - "Compile aarch64 PHP 84 nts + zts + debug"
          name: "Link aarch64 PHP"
          docker_image: "datadog/dd-trace-ci:centos-7"
          resource_class: "arm.xlarge"

      - pecl_build:
          requires: [ 'Prepare Code' ]
          name: "Build PECL"

      - "package extension":
          requires:
            - "Link x86_64 alpine"
            - "Link aarch64 alpine"
            - "Link x86_64 PHP"
            - "Link aarch64 PHP"

            - "Compile Windows PHP 72 nts + zts"
            - "Compile Windows PHP 73 nts + zts"
            - "Compile Windows PHP 74 nts + zts"
            - "Compile Windows PHP 80 nts + zts"
            - "Compile Windows PHP 81 nts + zts"
            - "Compile Windows PHP 82 nts + zts"
            - "Compile Windows PHP 83 nts + zts"
            - "Compile Windows PHP 84 nts + zts"
            - "Build PECL"

            - "Profiler PHP v7.1 - x86_64-alpine-linux-musl"
            - "Profiler PHP v7.2 - x86_64-alpine-linux-musl"
            - "Profiler PHP v7.3 - x86_64-alpine-linux-musl"
            - "Profiler PHP v7.4 - x86_64-alpine-linux-musl"
            - "Profiler PHP v8.0 - x86_64-alpine-linux-musl"
            - "Profiler PHP v8.1 - x86_64-alpine-linux-musl"
            - "Profiler PHP v8.2 - x86_64-alpine-linux-musl"
            - "Profiler PHP v8.3 - x86_64-alpine-linux-musl"
            - "Profiler PHP v8.4 - x86_64-alpine-linux-musl"

            - "Profiler PHP v7.1 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v7.2 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v7.3 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v7.4 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v8.0 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v8.1 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v8.2 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v8.3 - x86_64-unknown-linux-gnu"
            - "Profiler PHP v8.4 - x86_64-unknown-linux-gnu"

            - "Profiler PHP v7.1 - aarch64-alpine-linux-musl"
            - "Profiler PHP v7.2 - aarch64-alpine-linux-musl"
            - "Profiler PHP v7.3 - aarch64-alpine-linux-musl"
            - "Profiler PHP v7.4 - aarch64-alpine-linux-musl"
            - "Profiler PHP v8.0 - aarch64-alpine-linux-musl"
            - "Profiler PHP v8.1 - aarch64-alpine-linux-musl"
            - "Profiler PHP v8.2 - aarch64-alpine-linux-musl"
            - "Profiler PHP v8.3 - aarch64-alpine-linux-musl"
            - "Profiler PHP v8.4 - aarch64-alpine-linux-musl"

            - "Profiler PHP v7.1 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v7.2 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v7.3 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v7.4 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v8.0 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v8.1 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v8.2 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v8.3 - aarch64-unknown-linux-gnu"
            - "Profiler PHP v8.4 - aarch64-unknown-linux-gnu"

            - "Compile Loader Linux x86_64"
            - "Compile Loader Linux aarch64"
            - "Compile Loader Alpine x86_64"
            - "Compile Loader Alpine aarch64"

            - compile_appsec_extension_centos
            - compile_appsec_extension_alpine
            - compile_appsec_helper

      - compile_extension_asan:
          name: "Compile x86_64 PHP 74 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          so_suffix: "20190902"
      - compile_extension_asan:
          name: "Compile aarch64 PHP 74 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          so_suffix: "20190902"
          resource_class: "arm.medium"
      - compile_extension_asan:
          name: "Compile x86_64 PHP 80 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
          so_suffix: "20200930"
      - compile_extension_asan:
          name: "Compile aarch64 PHP 80 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
          so_suffix: "20200930"
          resource_class: "arm.medium"
      - compile_extension_asan:
          name: "Compile x86_64 PHP 81 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.1_buster"
          so_suffix: "20210902"
      - compile_extension_asan:
          name: "Compile aarch64 PHP 81 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.1_buster"
          so_suffix: "20210902"
          resource_class: "arm.medium"
      - compile_extension_asan:
          name: "Compile x86_64 PHP 82 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.2_buster"
          so_suffix: "20220829"
      - compile_extension_asan:
          name: "Compile aarch64 PHP 82 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.2_buster"
          so_suffix: "20220829"
          resource_class: "arm.medium"
      - compile_extension_asan:
          name: "Compile x86_64 PHP 83 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          so_suffix: "20230831"
      - compile_extension_asan:
          name: "Compile aarch64 PHP 83 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          so_suffix: "20230831"
          resource_class: "arm.medium"
      - compile_extension_asan:
          requires: [ 'Prepare Code' ]
          name: "Compile x86_64 PHP 84 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"
          so_suffix: "20240924"
      - compile_extension_asan:
          requires: [ 'Prepare Code' ]
          name: "Compile aarch64 PHP 84 debug-zts-asan"
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"
          so_suffix: "20240924"
          resource_class: "arm.medium"

      - "package extension":
          name: "package extension zts-debug-asan"
          asan_build: true
          requires:
            - "Prepare Code"
            - "Compile x86_64 PHP 74 debug-zts-asan"
            - "Compile aarch64 PHP 74 debug-zts-asan"
            - "Compile x86_64 PHP 80 debug-zts-asan"
            - "Compile aarch64 PHP 80 debug-zts-asan"
            - "Compile x86_64 PHP 81 debug-zts-asan"
            - "Compile aarch64 PHP 81 debug-zts-asan"
            - "Compile x86_64 PHP 82 debug-zts-asan"
            - "Compile aarch64 PHP 82 debug-zts-asan"
            - "Compile x86_64 PHP 83 debug-zts-asan"
            - "Compile aarch64 PHP 83 debug-zts-asan"
            - "Compile x86_64 PHP 84 debug-zts-asan"
            - "Compile aarch64 PHP 84 debug-zts-asan"

      - "x-profiling phpt tests on Alpine":
          requires: [ 'package extension' ]
          matrix:
            parameters:
              php_major_minor:
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'

      - randomized_tests:
          requires: [ 'package extension' ]
          matrix:
            parameters:
              batch: [ 1, 2, 3, 4, 5 ]
      - randomized_tests_arm:
          requires: [ 'package extension' ]
          matrix:
            parameters:
              batch: [ 1, 2, 3, 4, 5 ]
      - randomized_tests_asan:
          requires: [ 'package extension zts-debug-asan' ]
          matrix:
            parameters:
              batch: [ 6, 7, 8, 9, 10 ]
      - randomized_tests_arm_asan:
          requires: [ 'package extension zts-debug-asan' ]
          matrix:
            parameters:
              batch: [ 6, 7, 8, 9, 10 ]
      - installer_tests:
          requires: [ 'package extension' ]
      - test_early_php_81:
          requires: [ 'package extension' ]
      - placeholder:
          requires: [ 'package extension' ]
          name: Framework tests
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: flow
          name: "Flow testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: flow_no_ddtrace
          name: "Flow baseline testsuite"
      # The dd-trace-ci:php-framework-laravel docker image needs to be modified to handle the laravel queue integration
      #- framework_tests:
      #    requires: [ "Framework tests" ]
      #    framework_target: laravel
      #    name: "Laravel testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: laravel_no_ddtrace
          name: "Laravel baseline testsuite"
      # Symfony path needs to be updated as symfony/contracts 2.0 has been released and it changes
      # test files where the patch is applied.
      # - framework_tests:
      #     requires: [ "Framework tests" ]
      #     framework_target: symfony
      #     name: "Symfony testsuite"
      # - framework_tests:
      #     requires: [ "Framework tests" ]
      #     framework_target: symfony_no_ddtrace
      #     name: "Symfony baseline testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: mongodb-driver
          name: "Mongodb driver testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: mongodb-driver_no_ddtrace
          name: "Mongodb driver baseline testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: phpredis3
          name: "PHPRedis 3 testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: phpredis3_no_ddtrace
          name: "PHPRedis 3 baseline testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: phpredis4
          name: "PHPRedis 4 testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: phpredis4_no_ddtrace
          name: "PHPRedis 4 baseline testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: phpredis5
          name: "PHPRedis 5 testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: phpredis5_no_ddtrace
          name: "PHPRedis 5 baseline testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: wordpress
          name: "WordPress testsuite"
      - framework_tests:
          requires: [ "Framework tests" ]
          framework_target: wordpress_no_ddtrace
          name: "WordPress baseline testsuite"
      - verify_alpine:
          requires: [ "package extension" ]
          matrix:
            parameters:
              php_package:
                - php php-fpm php-json
              install_type:
                - php_installer
                - native_package
              docker_image:
                - alpine:3.8
                - alpine:3.9
                - alpine:3.10
                - alpine:3.11
                - alpine:3.12
                - alpine:3.15
                - alpine:3.16
                - alpine:3.17
                - alpine:latest
      - verify_alpine:
          requires: [ "package extension" ]
          matrix:
            parameters:
              php_package:
                - php7 php7-fpm php7-json
              install_type:
                - php_installer
                - native_package
              docker_image:
                - alpine:3.7
                - alpine:3.8
                - alpine:3.9
                - alpine:3.9
                - alpine:3.10
                - alpine:3.11
                - alpine:3.12
                - alpine:3.15
      - verify_alpine:
          requires: [ "package extension" ]
          php_package: ''
          matrix:
            parameters:
              install_type:
                - php_installer
                - native_package
              docker_image:
                - php:7.0-fpm-alpine
                - php:7.1-fpm-alpine
                - php:7.2-fpm-alpine
                - php:7.3-fpm-alpine
                - php:7.4-fpm-alpine
                - php:8.0-fpm-alpine
                - php:8.1-fpm-alpine
                - php:8.2-fpm-alpine
                - php:8.3-fpm-alpine
                - php:8.4-fpm-alpine
      - verify_centos:
          requires: [ "package extension" ]
          matrix:
            parameters:
              docker_image:
                - centos:7
              install_type:
                - php_installer
                - native_package
              configuration:
                - PHP_MAJOR=7 PHP_MINOR=0
                - PHP_MAJOR=7 PHP_MINOR=1
                - PHP_MAJOR=7 PHP_MINOR=2
                - PHP_MAJOR=7 PHP_MINOR=3
                - PHP_MAJOR=7 PHP_MINOR=4
                - PHP_MAJOR=8 PHP_MINOR=0
                - PHP_MAJOR=8 PHP_MINOR=1
                - PHP_MAJOR=8 PHP_MINOR=2
                - PHP_MAJOR=8 PHP_MINOR=3
                - PHP_MAJOR=8 PHP_MINOR=4
      - verify_debian:
          requires: [ "package extension" ]
          matrix:
            parameters:
              install_type:
                - php_installer
                - native_package
              install_mode:
                - sury
              docker_image:
                - debian:bullseye
                - debian:bookworm
              configuration:
                - PHP_VERSION=7.0
                - PHP_VERSION=7.1
                - PHP_VERSION=7.2
                - PHP_VERSION=7.3
                - PHP_VERSION=7.4
                - PHP_VERSION=8.0
                - PHP_VERSION=8.1
                - PHP_VERSION=8.2
                - PHP_VERSION=8.3
                - PHP_VERSION=8.4

      - verify_tar_gz:
          requires: [ "package extension" ]
          name: "Verify x86_64 .tar.gz"
          php_major_minor: "7.0"
      - verify_tar_gz:
          requires: [ "package extension" ]
          name: "Verify aarch64 .tar.gz"
          php_major_minor: "8.1"
          resource_class: "arm.medium"
        # There is little value in testing several versions, since all the packages are already verified on the
        # respective platforms using the native packages. Let's save some CPU cycles.

      - verify_no_json_ext:
          requires: [ "package extension" ]

      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 70 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-7.0_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 71 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-7.1_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 72 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-7.2_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 73 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-7.3_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 74 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 80 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 81 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-8.1_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 82 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-8.2_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 83 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
      - pecl_tests:
          requires: [ "Build PECL" ]
          name: "PHP 84 PECL tests"
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"

      - min_install_tests:
          requires: [ 'package extension' ]
          name: "PHP min install tests"
          matrix:
            parameters:
              php_version:
                - '8.0'

      - system_tests:
          requires: [ 'package extension' ]
          name: "System tests"
          build: |
            cd system-tests
            ./build.sh php
          run: |
            cd system-tests
            DD_API_KEY=$SYSTEM_TESTS_DD_API_KEY ./run.sh

      - system_tests:
          requires: [ 'package extension' ]
          name: "System tests Integration Tests"
          build: |
            cd system-tests
            ./build.sh php
          run: |
            export SYSTEM_TESTS_AWS_ACCESS_KEY_ID=$SYSTEM_TESTS_IDM_AWS_ACCESS_KEY_ID
            export SYSTEM_TESTS_AWS_SECRET_ACCESS_KEY=$SYSTEM_TESTS_IDM_AWS_SECRET_ACCESS_KEY
            cd system-tests
            DD_API_KEY=$SYSTEM_TESTS_DD_API_KEY ./run.sh INTEGRATIONS

      - system_tests:
          requires: [ 'package extension' ]
          name: "System tests Crossed Tracer Propagation Tests for Messaging"
          build: |
            cd system-tests
            ./build.sh php
          run: |
            export SYSTEM_TESTS_AWS_ACCESS_KEY_ID=$SYSTEM_TESTS_IDM_AWS_ACCESS_KEY_ID
            export SYSTEM_TESTS_AWS_SECRET_ACCESS_KEY=$SYSTEM_TESTS_IDM_AWS_SECRET_ACCESS_KEY
            cd system-tests
            DD_API_KEY=$SYSTEM_TESTS_DD_API_KEY ./run.sh CROSSED_TRACING_LIBRARIES

      - system_tests:
          requires: [ 'package extension' ]
          name: "Parametric tests"
          build: |
            cd system-tests
            export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
            sudo apt-get install -y python-is-python3
            ./build.sh -i runner
          run: |
            cd system-tests
            export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
            TEST_LIBRARY=php ./run.sh PARAMETRIC

      - "compile_loader":
          name: "Compile Loader Linux x86_64"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          resource_class: "medium"
          os: "linux-gnu"

      - "compile_loader":
          name: "Compile Loader Linux aarch64"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          resource_class: "arm.medium"
          os: "linux-gnu"

      - "compile_loader":
          name: "Compile Loader Alpine x86_64"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.0"
          resource_class: "medium"
          os: "linux-musl"

      - "compile_loader":
          name: "Compile Loader Alpine aarch64"
          docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.0"
          resource_class: "arm.medium"
          os: "linux-musl"

      - "test_loader_linux":
          requires:
            - "package extension"
          name: "[Linux/x86_64] Loader PHP << matrix.php_major_minor >>-<< matrix.switch_php_version >>"
          docker_image: "datadog/dd-trace-ci:php-<< matrix.php_major_minor >>_buster"
          resource_class: "medium"
          matrix:
            parameters:
              php_major_minor:
                - "5.6"
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
              switch_php_version:
                - nts

      - "test_loader_linux":
          requires:
            - "package extension"
          name: "[Linux/x86_64] Loader PHP << matrix.php_major_minor >>-<< matrix.switch_php_version >>"
          docker_image: "datadog/dd-trace-ci:php-<< matrix.php_major_minor >>_buster"
          resource_class: "medium"
          use_valgrind: true
          matrix:
            parameters:
              php_major_minor:
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              switch_php_version:
                - zts
                - nts

      - "test_loader_linux":
          requires:
            - "package extension"
          name: "[Linux/aarch64] Loader PHP << matrix.php_major_minor >>-<< matrix.switch_php_version >>"
          docker_image: "datadog/dd-trace-ci:php-<< matrix.php_major_minor >>_buster"
          resource_class: "arm.medium"
          matrix:
            parameters:
              php_major_minor:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
              switch_php_version:
                - nts

      - "test_loader_linux":
          requires:
            - "package extension"
          name: "[Linux/aarch64] Loader PHP << matrix.php_major_minor >>-<< matrix.switch_php_version >>"
          docker_image: "datadog/dd-trace-ci:php-<< matrix.php_major_minor >>_buster"
          resource_class: "arm.medium"
          matrix:
            parameters:
              php_major_minor:
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              switch_php_version:
                - zts
                - nts

      - "test_loader_alpine":
          requires:
            - "package extension"
          name: "[Alpine/x86_64] Loader PHP Alpine << matrix.alpine_version >>"
          docker_image: "alpine:<< matrix.alpine_version >>"
          resource_class: "medium"
          alpine_packages: "php83 php83-dev php83-pecl-xdebug"
          matrix:
            parameters:
              alpine_version:
                # - "3.19"
                - "3.20"
                # - "latest"

      - "test_loader_alpine":
          requires:
            - "package extension"
          name: "[Alpine/aarch64] Loader PHP Alpine << matrix.alpine_version >>"
          docker_image: "alpine:<< matrix.alpine_version >>"
          resource_class: "arm.medium"
          alpine_packages: "php83 php83-dev php83-pecl-xdebug"
          matrix:
            parameters:
              alpine_version:
                # - "3.19"
                - "3.20"
                # - "latest"

  build:
    when: << pipeline.parameters.build >>
    jobs:

      - "Prepare Code"

      - "cache cargo deps":
          name: "cache cargo deps - x86_64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:buster"
          triplet: "x86_64-unknown-linux-gnu"
      - "cache cargo deps":
          name: "cache cargo deps - aarch64-unknown-linux-gnu"
          docker_image: "datadog/dd-trace-ci:buster"
          triplet: "aarch64-unknown-linux-gnu"
          resource_class: "arm.medium"

      - compile_rust_test:
          name: "Compile rust code for testing"
          resource_class: xlarge
          triplet: "x86_64-unknown-linux-gnu"

      - compile_rust_test:
          name: "medium: Compile ASAN rust code for testing"
          resource_class: xlarge
          triplet: "x86_64-unknown-linux-gnu"
          asan: true
      - compile_rust_test:
          name: "arm.medium: Compile ASAN rust code for testing"
          resource_class: arm.xlarge
          triplet: "aarch64-unknown-linux-gnu"
          asan: true

      - compile_extension_test:
          name: "Compile << matrix.php_major_minor >> extension for testing"
          matrix:
            parameters:
              php_major_minor:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              switch_php_version:
                - debug

      - compile_extension_test:
          name: "<< matrix.resource_class >>: Compile << matrix.php_major_minor >> ZTS asan extension for testing"
          matrix:
            parameters:
              php_major_minor:
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              switch_php_version:
                - debug-zts-asan
              resource_class:
                - medium
                - arm.medium

      - test:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          matrix:
            parameters:
              php_major_minor:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              make_target:
                # - test_coverage
                - test_unit
                - test_api_unit
                - test_c2php
                - test_c_disabled
                - test_internal_api_randomized
                - test_opcache

      - test:
          requires: [ 'Prepare Code' ]
          matrix:
            parameters:
              php_major_minor:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              make_target:
                # - test_coverage

      - test:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          coverage: true
          codecov_flags: tracer-php
          matrix:
            parameters:
              php_major_minor:
                - "7.4"
                - "8.2"
              make_target:
                - test_unit_coverage

      - test:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          matrix:
            parameters:
              php_major_minor:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
              make_target:
                - test_extension_ci

      - test:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          matrix:
            parameters:
              resource_class:
                - medium+
              php_major_minor:
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              make_target:
                - test_extension_ci

      - test_windows:
          requires: [ 'Prepare Code' ]
          matrix:
            parameters:
              docker_image:
                - "datadog/dd-trace-ci:php-7.2_windows"
                - "datadog/dd-trace-ci:php-7.3_windows"
                - "datadog/dd-trace-ci:php-7.4_windows"
                - "datadog/dd-trace-ci:php-8.0_windows"
                - "datadog/dd-trace-ci:php-8.1_windows"
                - "datadog/dd-trace-ci:php-8.2_windows"
                - "datadog/dd-trace-ci:php-8.3_windows"
                - "datadog/dd-trace-ci:php-8.4_windows"

      # sidecar is version independent
      - test_sidecar_sender:
          requires: [ 'Prepare Code', 'medium: Compile 8.2 ZTS asan extension for testing', 'medium: Compile ASAN rust code for testing' ]
          php_major_minor: '8.2'
          switch_php_version: debug-zts-asan
          resource_class: medium

      - test_multi_observer:
          requires: [ 'Prepare Code', 'medium: Compile << matrix.php_major_minor >> ZTS asan extension for testing', 'medium: Compile ASAN rust code for testing' ]
          matrix:
            parameters:
              php_major_minor:
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              switch_php_version:
                - debug-zts-asan

      - coverage:
          requires: [ 'Prepare Code' ]
          matrix:
            parameters:
              php_major_minor:
                - "7.0"
                - "7.1"
                - "7.2"
                - "7.3"
                - "7.4"
                - "8.0"
                - "8.1"
                - "8.2"
                - "8.3"
                - "8.4"
              make_target:
                # - test_coverage
      - asan:
          requires: [ 'Prepare Code', '<< matrix.resource_class >>: Compile << matrix.php_major_minor >> ZTS asan extension for testing', '<< matrix.resource_class >>: Compile ASAN rust code for testing' ]
          matrix:
            parameters:
              php_major_minor:
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
              switch_php_version:
                - debug-zts-asan
              resource_class:
                - medium
                - arm.medium
              make_target:
                - test_c
                - test_with_init_hook
                - test_internal_api_randomized
                - test_opcache
            exclude:
                # apparently for no discernible reason, on x86 asan builds PHP 7.4. fails to allocate opcache shared memory
              - php_major_minor: '7.4'
                resource_class: medium
                make_target: test_opcache
                switch_php_version: debug-zts-asan

      - integration:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          resource_class: large
          matrix:
            parameters:
              php_major_minor:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
              make_target:
                - test_auto_instrumentation
                - test_composer
                - test_distributed_tracing
                - test_integration

      - integration:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          resource_class: medium+
          coverage: true
          codecov_flags: tracer-php
          matrix:
            parameters:
              php_major_minor:
                - '7.4'
                - '8.2'
              make_target:
                - test_integration_coverage
                - test_distributed_tracing_coverage

      - integration_snapshots:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          # Due to Symfony OOM during composer update
          resource_class: xlarge
          matrix:
            alias: integration_snapshots_tests
            parameters:
              php_major_minor:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
              make_target:
                - test_web
                - test_integrations

      - aggregate_tested_versions:
          filters:
            branches:
              only: master
          requires:
            - integration_snapshots_tests:
                - success
                - failed

      - integration_snapshots:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          # Due to Symfony OOM during composer update
          resource_class: xlarge
          coverage: true
          codecov_flags: tracer-php
          matrix:
            alias: integration_snapshots_tests_coverage
            parameters:
              php_major_minor:
                - '7.4'
                - '8.2'
              make_target:
                - test_web_coverage
                - test_integrations_coverage

      - integration:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          resource_class: medium+
          sapi: fpm-fcgi
          disable_runner_distributed_tracing: true
          with_executor: 'with_httpbin_and_request_replayer'
          matrix:
            parameters:
              php_major_minor:
                - '7.0'
                - '7.1'
                - '7.2'
                - '7.3'
                - '7.4'
                - '8.0'
                - '8.1'
                - '8.2'
                - '8.3'
                - '8.4'
              make_target:
                - test_distributed_tracing

      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 7.2 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 72 web tests with apache (+ opcache)"
          resource_class: medium+
          sapi: apache2handler
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-7.2_buster"
          php_major_minor: "7.2"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 7.2 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 72 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-7.2_buster"
          php_major_minor: "7.2"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 7.3 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 73 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-7.3_buster"
          php_major_minor: "7.3"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 7.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 74 web tests with apache (+ opcache)"
          resource_class: medium+
          sapi: apache2handler
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          php_major_minor: "7.4"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 7.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 74 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          php_major_minor: "7.4"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.0 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 80 web tests with apache (+ opcache)"
          resource_class: medium+
          sapi: apache2handler
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
          php_major_minor: "8.0"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.0 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 80 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
          php_major_minor: "8.0"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.1 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 81 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.1_buster"
          php_major_minor: "8.1"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.2 extension for testing', 'Compile rust code for testing']
          name: "PHP 82 web tests with apache (+ opcache)"
          resource_class: medium+
          sapi: apache2handler
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.2_buster"
          php_major_minor: "8.2"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.3 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 83 web tests with apache (+ opcache)"
          resource_class: medium+
          sapi: apache2handler
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          php_major_minor: "8.3"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.3 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 83 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          php_major_minor: "8.3"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 84 web tests with apache (+ opcache)"
          resource_class: medium+
          sapi: apache2handler
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"
          php_major_minor: "8.4"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 8.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 84 web tests with nginx + FastCGI"
          resource_class: medium+
          sapi: cgi-fcgi
          make_target: "test_web"
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"
          php_major_minor: "8.4"
      - integration_tests:
          requires: [ 'Prepare Code', 'Compile 7.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 74 custom autoloaded web tests with nginx + PHP-FPM"
          resource_class: medium+
          sapi: fpm-fcgi
          make_target: "test_web_custom"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          php_major_minor: "7.4"

      - integration:
          requires: [ 'Prepare Code', 'Compile << matrix.php_major_minor >> extension for testing', 'Compile rust code for testing' ]
          resource_class: medium+
          sapi: fpm-fcgi
          disable_runner_distributed_tracing: true
          coverage: true
          codecov_flags: tracer-php
          with_executor: 'with_httpbin_and_request_replayer'
          matrix:
            parameters:
              php_major_minor:
                - '7.4'
                - '8.2'
              make_target:
                - test_distributed_tracing_coverage

      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 7.0 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 70 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-7.0_buster"
          xdebug_version_one: "2.7.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 7.1 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 71 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-7.1_buster"
          xdebug_version_one: "2.9.5"
          xdebug_version_two: "2.9.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 7.2 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 72 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-7.2_buster"
          xdebug_version_one: "2.9.5"
          xdebug_version_two: "2.9.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 7.3 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 73 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-7.3_buster"
          xdebug_version_one: "2.9.5"
          xdebug_version_two: "2.9.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 7.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 74 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          xdebug_version_one: "2.9.5"
          xdebug_version_two: "2.9.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 8.0 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 80 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
          xdebug_version_one: "3.0.0"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 8.1 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 81 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-8.1_buster"
          xdebug_version_one: "3.1.0"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 8.2 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 82 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-8.2_buster"
          xdebug_version_one: "3.2.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 8.3 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 83 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          xdebug_version_one: "3.3.2"
      - xdebug_tests:
          requires: [ 'Prepare Code', 'Compile 8.4 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 84 Xdebug tests"
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"
          xdebug_version_one: "3.4.0"

      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 8.4 extension for testing' ]
          name: "PHP 84 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/8.4.list
          docker_image: "datadog/dd-trace-ci:php-8.4_buster"
          parallel_workers: true
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 8.3 extension for testing' ]
          name: "PHP 83 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/8.3.list
          docker_image: "datadog/dd-trace-ci:php-8.3_buster"
          parallel_workers: true
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 8.2 extension for testing' ]
          name: "PHP 82 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/8.2.list
          docker_image: "datadog/dd-trace-ci:php-8.2_buster"
          parallel_workers: true
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 8.1 extension for testing' ]
          name: "PHP 81 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/8.1.list
          docker_image: "datadog/dd-trace-ci:php-8.1_buster"
          parallel_workers: true
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 8.0 extension for testing' ]
          name: "PHP 80 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/8.0.list
          docker_image: "datadog/dd-trace-ci:php-8.0_buster"
          parallel_workers: true
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 7.4 extension for testing' ]
          name: "PHP 74 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/7.4.list
          docker_image: "datadog/dd-trace-ci:php-7.4_buster"
          parallel_workers: true
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 7.3 extension for testing' ]
          name: "PHP 73 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/7.3.list
          docker_image: "datadog/dd-trace-ci:php-7.3_buster"
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 7.2 extension for testing' ]
          name: "PHP 72 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/7.2.list
          docker_image: "datadog/dd-trace-ci:php-7.2_buster"
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 7.1 extension for testing' ]
          name: "PHP 71 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/7.1.list
          docker_image: "datadog/dd-trace-ci:php-7.1_buster"
      - php_language_tests:
          requires: [ 'Compile rust code for testing', 'Compile 7.0 extension for testing' ]
          name: "PHP 70 language tests"
          xfail_list: dockerfiles/ci/xfail_tests/7.0.list
          docker_image: "datadog/dd-trace-ci:php-7.0_buster"
      - internal_integrations:
          requires: [ 'Prepare Code', 'Compile 8.0 extension for testing', 'Compile rust code for testing' ]
          name: "PHP 80 curl integration tests a shared lib"
          ext_name: "curl"
          docker_image: "datadog/dd-trace-ci:php-8.0-shared-ext"
      - static_analysis:
          requires: [ 'Prepare Code', 'Compile 7.1 extension for testing', 'Compile rust code for testing' ]
          name: "Static Analysis 71"
          docker_image: datadog/dd-trace-ci:php-7.1_buster
          scenario: opentracing_beta6
      - static_analysis:
          requires: [ 'Prepare Code', 'Compile 8.0 extension for testing', 'Compile rust code for testing' ]
          name: "Static Analysis 80"
          docker_image: datadog/dd-trace-ci:php-8.0_buster
          scenario: opentracing10
      - "generated files up-to-date"
      - "Post-Install Hook":
          requires: [ 'Prepare Code' ]

  appsec_tests:
    when: << pipeline.parameters.appsec >>
    jobs:
    - "Prepare Code"
    - hunter_cache_debian:
        requires: [ 'Prepare Code' ]
        matrix:
          parameters:
            resource_class:
              - medium
              - arm.medium

    - hunter_cache_ubuntu:
        requires: [ 'Prepare Code' ]
        matrix:
          parameters:
            resource_class:
              - medium
              - arm.medium

    - test_appsec_extension:
        requires: [ hunter_cache_debian ]
        matrix:
          parameters:
            php_major_minor:
              - "7.0"
              - "7.1"
              - "7.2"
              - "7.3"
              - "7.4"
              - "8.0"
              - "8.1"
              - "8.2"
              - "8.3"
              - "8.4"
            resource_class:
              - medium
              - arm.medium
            switch_php_version:
              - debug

    - test_appsec_extension:
        requires: [ hunter_cache_debian ]
        matrix:
          parameters:
            php_major_minor:
              - "7.0"
              - "7.1"
              - "7.2"
              - "7.3"
            resource_class:
              - medium
              - arm.medium
            switch_php_version:
              - debug-zts

    - test_appsec_extension:
        requires: [ hunter_cache_debian ]
        matrix:
          parameters:
            php_major_minor:
              - "7.4"
              - "8.0"
              - "8.1"
              - "8.2"
              - "8.3"
              - "8.4"
            resource_class:
              - medium
              - arm.medium
            switch_php_version:
              - debug-zts-asan

    - test_appsec_integration:
        matrix:
          parameters:
            resource_class:
              - large
            targets:
              - test7.0-release test7.0-release-zts test7.1-release test7.1-release-zts test7.2-release test7.2-release-zts
              - test7.3-release test7.3-release-zts test7.4-release test7.4-release-zts test8.0-release test8.0-release-zts
              - test8.1-release test8.1-release-zts test8.2-release test8.2-release-zts test8.3-release test8.3-release-zts test8.4-release test8.4-release-zts

    - coverage_appsec:
        requires: [ hunter_cache_ubuntu ]
        matrix:
          parameters:
            resource_class:
              - medium
              - arm.medium

    - lint_appsec:
        requires: [ hunter_cache_ubuntu ]

    - test_appsec_helper_asan:
        requires: [ hunter_cache_ubuntu ]
        matrix:
          parameters:
            resource_class:
              - medium
              - arm.medium

    - fuzz_appsec_helper:
        requires: [ hunter_cache_ubuntu ]
        matrix:
          parameters:
            resource_class:
              - medium
              - arm.medium

  profiling_tests:
    when: << pipeline.parameters.profiling >>
    jobs:
    - "profiling tests":
        name: "Profiler test PHP v7.1 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.1"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v7.1 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.1"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v7.2 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.2"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v7.2 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.2"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v7.3 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.3"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v7.3 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.3"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v7.4 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.4"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v7.4 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-7.4"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.0 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.0"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v8.0 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.0"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.1 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.1"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v8.1 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.1"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.2 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.2"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v8.2 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.2"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.3 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.3"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v8.3 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.3"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.4 - x86_64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.4"
        triplet: "x86_64-alpine-linux-musl"
    - "profiling tests":
        name: "Profiler test PHP v8.4 - aarch64-alpine-linux-musl"
        docker_image: "datadog/dd-trace-ci:php-compile-extension-alpine-8.4"
        triplet: "aarch64-alpine-linux-musl"
        resource_class: "arm.medium"

    - "profiling tests":
        name: "Profiler test PHP v7.1 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.1_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v7.1 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.1_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v7.2 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.2_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v7.2 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.2_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v7.3 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.3_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v7.3 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.3_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v7.4 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.4_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v7.4 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-7.4_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.0 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.0_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v8.0 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.0_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.1 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.1_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v8.1 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.1_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.2 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.2_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v8.2 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.2_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.3 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.3_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v8.3 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.3_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"
    - "profiling tests":
        name: "Profiler test PHP v8.4 - x86_64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.4_centos-7"
        triplet: "x86_64-unknown-linux-gnu"
    - "profiling tests":
        name: "Profiler test PHP v8.4 - aarch64-unknown-linux-gnu"
        docker_image: "datadog/dd-trace-ci:php-8.4_centos-7"
        triplet: "aarch64-unknown-linux-gnu"
        resource_class: "arm.medium"