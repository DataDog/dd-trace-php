stages:
  - build
  - deploy

build:
  tags: ["runner:docker", "size:large"]
  stage: build
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:v3892323-786b6fd-20.10.3
  script:
    - docker version
    - docker buildx install
    - docker build -f dockerfiles/packaging/Dockerfile . --target export -t tmp_export 
    - docker image save tmp_export  | tar --wildcards --strip-components=1 -x '*/layer.tar'
    - mkdir artifacts
    - tar -xf layer.tar -C artifacts
  artifacts:
    paths:
      - 'artifacts/'

deploy_to_reliability_env:
  stage: deploy
  when: on_success
  trigger:
    project: DataDog/datadog-reliability-env
    branch: landerson/php-downstream
  variables:
    UPSTREAM_PACKAGE_JOB: build
    UPSTREAM_BRANCH: $CI_COMMIT_REF_NAME
    UPSTREAM_PROJECT_ID: $CI_PROJECT_ID
    UPSTREAM_PROJECT_NAME: $CI_PROJECT_NAME
    UPSTREAM_COMMIT_SHA: $CI_COMMIT_SHA
    FORCE_TRIGGER: $FORCE_TRIGGER