BUILD_SUFFIX := extension
BUILD_DIR := tmp/build_$(BUILD_SUFFIX)
SO_FILE := $(BUILD_DIR)/modules/ddtrace.so
WALL_FLAGS := -Wall -Werror -Wextra
CFLAGS := -O2 $(WALL_FLAGS)

INI_FILE := /usr/local/etc/php/conf.d/ddtrace.ini

all: configure $(SO_FILE)

configure: config.m4
	phpize

$(BUILD_DIR)/Makefile: configure
	mkdir -p $(BUILD_DIR)
	cd $(BUILD_DIR); $(abspath configure)

$(SO_FILE): $(BUILD_DIR)/Makefile
	$(MAKE) -C $(BUILD_DIR) CFLAGS="$(CFLAGS)"

install: $(SO_FILE)
	$(SUDO) $(MAKE) -C $(BUILD_DIR) install

$(INI_FILE):
	echo "extension=ddtrace.so" | $(SUDO) tee $@

install_ini: $(INI_FILE)

test_c: $(SO_FILE)
	$(MAKE) -C $(BUILD_DIR) test TESTS="-q --show-all $(TESTS)"

test_c_mem: $(SO_FILE)
	$(MAKE) -C $(BUILD_DIR) test TESTS="-q --show-all -m $(TESTS)"

test_integration: install_ini
	composer test -- $(PHPUNIT)

dist_clean:
	phpize --clean
	rm -rf $(BUILD_DIR)

clean:
	$(MAKE) -C $(BUILD_DIR) clean

EXT_DIR=/opt/datadog-php
FPM_INFO_OPTS=-n ddtrace --version 0.0.1 --provides ddtrace --vendor DataDog  --url https://datadog.com/ --no-depends
FPM_DIR_OPTS=--directories $(EXT_DIR)/etc --config-files $(EXT_DIR)/etc \
	-s dir extensions/=$(EXT_DIR)/extensions package/post-install.sh=$(EXT_DIR)/bin/post-install.sh tmp/etc/=$(EXT_DIR)/etc
tmp/etc:
	mkdir -p tmp/etc
ddtrace.deb: tmp/etc
	fpm -t deb $(FPM_INFO_OPTS) $(FPM_DIR_OPTS)
ddtrace.rpm: tmp/etc
	fpm -t rpm $(FPM_INFO_OPTS) $(FPM_DIR_OPTS)
ddtrace.tar: tmp/etc
	fpm -t tar $(FPM_INFO_OPTS) $(FPM_DIR_OPTS)

.PHONY: dist_clean clean all install sudo_install test_c test_c_mem test test_integration install_ini ddtrace.deb ddtrace.rpm

