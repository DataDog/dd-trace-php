.all_targets: &all_minor_major_targets
  - "7.0"
  - "7.1"
  - "7.2"
  - "7.3"
  - "7.4"
  - "8.0"
  - "8.1"
  - "8.2"
  - "8.3"
  - "8.4"

.non_asan_targets: &non_asan_minor_major_targets
  - "7.0"
  - "7.1"
  - "7.2"
  - "7.3"

.asan_targets: &asan_minor_major_targets
  - "7.4"
  - "8.0"
  - "8.1"
  - "8.2"
  - "8.3"
  - "8.4"

.arch_targets: &arch_targets
  - "amd64"
  - "arm64"

.agent_httpbin_service: &agent_httpbin_service
  - !reference [.services, test-agent]
  - !reference [.services, request-replayer]
  - !reference [.services, httpbin-integration]

.base_test:
  stage: test
  tags: [ "arch:${ARCH}" ]
  image: registry.ddbuild.io/images/mirror/datadog/dd-trace-ci:php-${PHP_MAJOR_MINOR}_buster
  variables:
    host_os: linux-gnu
    COMPOSER_MEMORY_LIMIT: "-1"
    DD_TRACE_ASSUME_COMPILED: "1"
    DDAGENT_HOSTNAME: "127.0.0.1"
    CI_DEBUG_SERVICES: "true"
  before_script:
    - switch-php "${SWITCH_PHP_VERSION}"
    - git config --global --add safe.directory "${CI_PROJECT_DIR}"
    - git config --global --add safe.directory "${CI_PROJECT_DIR}/*"
    - mkdir -p "tmp/build_extension/modules/"
    - mv "modules/${PHP_MAJOR_MINOR}-${SWITCH_PHP_VERSION}-${host_os}-${ARCH}/ddtrace.so" "tmp/build_extension/modules/"
    - for host in ${WAIT_FOR:-}; do wait-for $host --timeout=30; done
  after_script:
    - mv /usr/local/src/php/tests/output/*.log tests/ || true
    - mv /tmp/artifacts/ tests/ || true
    - .gitlab/check_test_agent.sh
    - .gitlab/check_for_core_dumps.sh

.all_arch_asan_test:
  extends: .base_test
  needs:
    - job: "compile extension: debug-zts-asan"
      artifacts: true
  parallel:
    matrix:
      - PHP_MAJOR_MINOR: *asan_minor_major_targets
        ARCH: *arch_targets
  variables:
    SWITCH_PHP_VERSION: debug-zts-asan

.asan_test:
  extends: .base_test
  needs:
    - job: "compile extension: debug-zts-asan"
      artifacts: true
  parallel:
    matrix:
      - PHP_MAJOR_MINOR: *asan_minor_major_targets
        ARCH: amd64
  variables:
    SWITCH_PHP_VERSION: debug-zts-asan

ASAN test_c:
  extends: .all_arch_asan_test
  services: *agent_httpbin_service
  variables:
    WAIT_FOR: test-agent:9126
  script:
    - make test_c

ASAN Internal api randomized tests:
  extends: .all_arch_asan_test
  script:
    - make test_internal_api_randomized

ASAN init hook tests:
  extends: .asan_test
  services:
    - !reference [.services, httpbin-integration]
  script:
    - make test_with_init_hook

ASAN Opcache tests:
  extends: .asan_test
  script:
    - make test_opcache

.debug_test:
  extends: .base_test
  needs:
    - job: "compile extension: debug"
      artifacts: true
  parallel:
    matrix:
      - PHP_MAJOR_MINOR: *all_minor_major_targets
        ARCH: amd64
  variables:
    SWITCH_PHP_VERSION: debug

Unit tests:
  extends: .debug_test
  script:
    - make test_unit

API unit tests:
  extends: .debug_test
  script:
    - make test_api_unit

Disabled test_c run:
  extends: .debug_test
  script:
    - make test_c_disabled

Internal api randomized tests:
  extends: .debug_test
  script:
    - make test_internal_api_randomized

Opcache tests:
  extends: .debug_test
  script:
    - make test_opcache
