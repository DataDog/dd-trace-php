"checkout code":
  stage: build
  tags: [ "arch:amd64" ]
  image: registry.ddbuild.io/images/mirror/bitnami/git:2.45.2
  variables:
    KUBERNETES_CPU_REQUEST: 1
    KUBERNETES_MEMORY_REQUEST: 1Gi
  script:
    - chown -R $(id -u):$(id -g) .
    - git submodule update --init --recursive
    - ./.gitlab/append-build-id.sh
  artifacts:
    paths:
      - "appsec/third_party/"
      - "libdatadog/"
      - "tea/benchmarks/google-benchmark/"
      - "VERSION"

"compile extension: debug":
  stage: build
  tags: [ "arch:${ARCH}" ]
  image: registry.ddbuild.io/images/mirror/datadog/dd-trace-ci:php-${PHP_MAJOR_MINOR}_buster
  needs:
    - job: "checkout code"
      artifacts: true
  parallel:
    matrix:
      - PHP_MAJOR_MINOR:
          - "7.0"
          - "7.1"
          - "7.2"
          - "7.3"
          - "7.4"
          - "8.0"
          - "8.1"
          - "8.2"
          - "8.3"
          - "8.4"
        ARCH:
          - "amd64"
          - "arm64"
  variables:
    host_os: linux_gnu
    SHARED: "1"
    ASAN: "0"
    CARGO_HOME: "/rust/cargo/"
    SWITCH_PHP_VERSION: "debug"
    KUBERNETES_CPU_REQUEST: 8
    KUBERNETES_MEMORY_REQUEST: 6Gi
  script: ".gitlab/compile_extension.sh"
  cache:
    - key:
        prefix: $CI_JOB_NAME
        files:
          - Cargo.lock
      paths:
        - /rust/cargo/
  artifacts:
    paths:
      - "appsec/third_party/"
      - "libdatadog/"
      - "tea/benchmarks/google-benchmark/"
      - VERSION
      - "tmp/build_extension/"

"compile extension: debug-zts-asan":
  extends: "compile extension: debug"
  variables:
    ASAN: "1"
    SWITCH_PHP_VERSION: "debug-zts-asan"
  parallel:
    matrix:
      - PHP_MAJOR_MINOR:
          - "7.4"
          - "8.0"
          - "8.1"
          - "8.2"
          - "8.3"
          - "8.4"
        ARCH:
          - "amd64"
          - "arm64"
