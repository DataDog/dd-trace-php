variables:
  CI_REGISTRY_USER:
    value: ""
    description: "Your docker hub username"
  CI_REGISTRY_TOKEN:
    value: ""
    description: "Your docker hub personal access token, can be created following this doc https://docs.docker.com/docker-hub/access-tokens/#create-an-access-token"
  CI_REGISTRY:
    value: "docker.io"

CentOS:
  stage: ci-build
  rules:
    - when: manual
  needs: []
  tags: ["arch:amd64"]
  timeout: 1h
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:24.0.4-gbi-focal
  parallel:
    matrix:
      - PHP_VERSION:
        - base
        - php-8.3
        - php-8.2
        - php-8.1
        - php-8.0
        - php-7.4
        - php-7.3
        - php-7.2
        - php-7.1
        - php-7.0
  script:
    - cd dockerfiles/ci/centos/7
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_TOKEN" $CI_REGISTRY
    - docker buildx bake --no-cache --pull --push $PHP_VERSION

Alpine Compile Extension:
  stage: ci-build
  rules:
    - when: manual
  needs: []
  tags: ["arch:amd64"]
  timeout: 1h
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:24.0.4-gbi-focal
  parallel:
    matrix:
      - PHP_VERSION:
        - base-alpine
        - 8.3-alpine
        - 8.2-alpine
        - 8.1-alpine
        - 8.0-alpine
        - 7.4-alpine
        - 7.3-alpine
        - 7.2-alpine
        - 7.1-alpine
        - 7.0-alpine
  script:
    - cd dockerfiles/ci/alpine_compile_extension
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_TOKEN" $CI_REGISTRY
    - docker buildx bake --no-cache --pull --push $PHP_VERSION

Ubuntu Bookworm:
  stage: ci-build
  rules:
    - when: manual
  needs: []
  tags: ["arch:amd64"]
  timeout: 1h
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:24.0.4-gbi-focal
  parallel:
    matrix:
      - PHP_VERSION:
        - base
        - php-8.3
        - php-8.2
        - php-8.1
        - php-8.0
        - php-8.0-shared-ext
        - php-7.4
        - php-7.4-shared-ext
        - php-7.3
        - php-7.2
        - php-7.1
        - php-7.0
  script:
    - cd dockerfiles/ci/bookworm
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_TOKEN" $CI_REGISTRY
    - docker buildx bake --no-cache --pull --push $PHP_VERSION

Ubuntu Buster:
  stage: ci-build
  rules:
    - when: manual
  needs: []
  tags: ["arch:amd64"]
  timeout: 1h
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:24.0.4-gbi-focal
  parallel:
    matrix:
      - PHP_VERSION:
        - base
        - php-8.3
        - php-8.2
        - php-8.1
        - php-8.0
        - php-8.0-shared-ext
        - php-7.4
        - php-7.4-shared-ext
        - php-7.3
        - php-7.2
        - php-7.1
        - php-7.0
  script:
    - cd dockerfiles/ci/buster
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_TOKEN" $CI_REGISTRY
    - docker buildx bake --no-cache --pull --push $PHP_VERSION

Windows:
  stage: ci-build
  rules:
    - when: manual
  needs: []
  tags: ["runner:windows-docker", "windowsversion:1809"]
  timeout: 1h
  parallel:
    matrix:
      - BUILD_NAME: "vc14-base"
        IMAGE_TAG: "datadog/dd-trace-ci:windows-base-vc14"
        DOCKERFILE: "vc14.Dockerfile"
      - BUILD_NAME: "vc15-base"
        IMAGE_TAG: "datadog/dd-trace-ci:windows-base-vc15"
        DOCKERFILE: "vc15.Dockerfile"
      - BUILD_NAME: "vs16-base"
        IMAGE_TAG: "datadog/dd-trace-ci:windows-base-vs16"
        DOCKERFILE: "vs16.Dockerfile"
      - BUILD_NAME: "vc14"
        IMAGE_TAG: "datadog/dd-trace-ci:windows-vc14"
        DOCKERFILE: "basetools.Dockerfile"
        ARGS: "--build-arg 'vsVersion=vc14' --build-arg 'sdkVersion=2.1.10'"
      - BUILD_NAME: "vc15"
        IMAGE_TAG: "datadog/dd-trace-ci:windows-vc15"
        DOCKERFILE: "basetools.Dockerfile"
        ARGS: "--build-arg 'vsVersion=vc15' --build-arg 'sdkVersion=2.2.0'"
      - BUILD_NAME: "vs16"
        IMAGE_TAG: "datadog/dd-trace-ci:windows-vs16"
        DOCKERFILE: "basetools.Dockerfile"
        ARGS: "--build-arg 'vsVersion=vs16' --build-arg 'sdkVersion=2.2.0'"
      - BUILD_NAME: "php-8.3"
        IMAGE_TAG: "datadog/dd-trace-ci:php-8.3_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=8.3.9 --build-arg vsVersion=vs16 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-8.3.9.tar.gz --build-arg phpSha256Hash=f484dec6ee005c83f899af02fc021e1bc3b1d7b3f143ca062ef66b0fcee96566"
      - BUILD_NAME: "php-8.2"
        IMAGE_TAG: "datadog/dd-trace-ci:php-8.2_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=8.2.21 --build-arg vsVersion=vs16 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-8.2.21.tar.gz --build-arg phpSha256Hash=0c6323699309a4d2e71057f01bc071b199f240973c349287b667a3ab36a496c6"
      - BUILD_NAME: "php-8.1"
        IMAGE_TAG: "datadog/dd-trace-ci:php-8.1_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=8.1.29 --build-arg vsVersion=vs16 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-8.1.29.tar.gz --build-arg phpSha256Hash=8b2609bf1d3173aa38269a9af21532c65f730aadd3051f9aae011eea9e246de5"
      - BUILD_NAME: "php-8.0"
        IMAGE_TAG: "datadog/dd-trace-ci:php-8.0_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=8.0.28 --build-arg vsVersion=vs16 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-8.0.28.tar.gz --build-arg phpSha256Hash=7432184eae01e4e8e39f03f80e8ec0ca2c8bfebc56e9a7b983541ca8805df22f"
      - BUILD_NAME: "php-7.4"
        IMAGE_TAG: "datadog/dd-trace-ci:php-7.4_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=7.4.33 --build-arg vsVersion=vc15 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-7.4.33.tar.gz --build-arg phpSha256Hash=5a2337996f07c8a097e03d46263b5c98d2c8e355227756351421003bea8f463e"
      - BUILD_NAME: "php-7.3"
        IMAGE_TAG: "datadog/dd-trace-ci:php-7.3_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=7.3.33 --build-arg vsVersion=vc15 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-7.3.33.tar.gz --build-arg phpSha256Hash=9a369c32c6f52036b0a890f290327f148a1904ee66aa56e2c9a7546da6525ec8"
      - BUILD_NAME: "php-7.2"
        IMAGE_TAG: "datadog/dd-trace-ci:php-7.2_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=7.2.34 --build-arg vsVersion=vc15 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-7.2.34.tar.gz --build-arg phpSha256Hash=8b2777c741e83f188d3ca6d8e98ece7264acafee86787298fae57e05d0dddc78"
      - BUILD_NAME: "php-7.1"
        IMAGE_TAG: "datadog/dd-trace-ci:php-7.1_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=7.1.33 --build-arg vsVersion=vc14 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-7.1.33.tar.gz --build-arg phpSha256Hash=0055f368ffefe51d5a4483755bd17475e88e74302c08b727952831c5b2682ea2"
      - BUILD_NAME: "php-7.0"
        IMAGE_TAG: "datadog/dd-trace-ci:php-7.0_windows"
        DOCKERFILE: "Dockerfile"
        ARGS: "--build-arg phpVersion=7.0.33 --build-arg vsVersion=vc14 --build-arg phpTarGzUrl=https://www.php.net/distributions/php-7.0.33.tar.gz --build-arg phpSha256Hash=d71a6ecb6b13dc53fed7532a7f8f949c4044806f067502f8fb6f9facbb40452a"
  hooks:
    pre_get_sources_script:
      - git config --system core.longpaths true
      - echo "{}" > C:\\Windows\\system32\\config\\systemprofile\\.docker\\config.json
      - type C:\\Windows\\system32\\config\\systemprofile\\.docker\\config.json
  script:
    - |
      cd dockerfiles/ci/windows
      docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_TOKEN" $CI_REGISTRY
      docker build --platform windows/amd64 -t $IMAGE_TAG -f $DOCKERFILE $ARGS .
      docker push $IMAGE_TAG
  after_script:
    - docker logout
